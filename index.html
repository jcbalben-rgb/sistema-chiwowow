<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi-Wow-Wow PRO | Sistema Integral de Gesti√≥n</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@400;600&display=swap');

        :root { 
            --brand-dark: #0D1B2A; 
            --brand-gold: #C5A022; 
            --success: #27ae60; 
            --danger: #c0392b; 
            --crm: #512E5F;
        }
        
        body { font-family: 'Open Sans', sans-serif; background-color: #414446; margin: 0; padding: 20px; color: #2C3E50; }

        /* --- LOGIN --- */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--brand-dark); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 15px; text-align: center; width: 320px; box-shadow: 0 25px 60px rgba(0,0,0,0.5); }
        .login-logo { max-width: 150px; margin-bottom: 20px; }

        /* --- NAVEGACION --- */
        .main-container { max-width: 1200px; margin: 0 auto; display: none; }
        .nav-bar { display: flex; gap: 12px; margin-bottom: 25px; justify-content: flex-end; }
        .nav-btn { background: #273746; color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; border-bottom: 3px solid transparent; }
        .nav-btn.active { background: white; color: var(--brand-dark); border-bottom: 3px solid var(--brand-gold); }
        .nav-btn.crm-btn { background: var(--crm); }

        /* --- PANELES --- */
        .control-panel { background: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; border-left: 8px solid var(--brand-dark); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .panel-title { font-family: 'Montserrat'; font-weight: 800; text-align: center; margin-bottom: 25px; color: var(--brand-dark); text-transform: uppercase; letter-spacing: 1px; }
        
        /* --- FORMULARIO --- */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 20px; }
        label { display: block; font-size: 0.75rem; font-weight: 700; color: #566573; margin-bottom: 8px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #D5DBDB; border-radius: 8px; font-size: 0.95rem; outline: none; }

        .abono-section { background: #FEF9E7; padding: 20px; border-radius: 10px; border: 1px solid #F1C40F; margin-top: 20px; position: relative; }
        .abono-section::before { content: "PAGOS Y ABONOS"; position: absolute; top: -10px; left: 20px; background: #F1C40F; color: white; padding: 2px 12px; font-size: 0.7rem; font-weight: 800; border-radius: 5px; }

        /* --- TABLAS --- */
        .db-table-container { overflow-x: auto; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .db-table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
        .db-table th { background: var(--brand-dark); color: white; padding: 15px; text-align: left; text-transform: uppercase; font-size: 0.75rem; }
        .db-table td { padding: 15px; border-bottom: 1px solid #EBEDEF; vertical-align: top; }
        .abono-tag { font-size: 0.72rem; background: #EBF5FB; color: #2E86C1; padding: 5px 10px; border-radius: 5px; display: inline-block; margin-right: 5px; margin-bottom: 5px; border-left: 3px solid #3498DB; font-weight: 600; }

        /* --- BOTONES --- */
        .btn-delete { background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .btn-edit { background: var(--brand-gold); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .btn-action { background: var(--brand-dark); color: white; border: none; padding: 18px; width: 100%; font-weight: 800; border-radius: 10px; cursor: pointer; margin-top: 15px; text-transform: uppercase; }

        /* --- DOCUMENTOS PARA IMPRESI√ìN --- */
        .document-page { display: none; background: white; width: 21.59cm; min-height: 27.94cm; margin: 0 auto 50px auto; padding: 1.5cm 2cm; box-sizing: border-box; box-shadow: 0 20px 50px rgba(0,0,0,0.3); position: relative; }
        .header-doc { display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--brand-dark); padding-bottom: 20px; margin-bottom: 30px; }
        .logo-doc { max-height: 80px; }
        
        /* ESTILO DEL CONTRATO */
        .contract-text { font-size: 8.5pt; text-align: justify; line-height: 1.3; color: #000; }
        .clause-title { color: var(--brand-dark); font-family: 'Montserrat'; font-weight: 800; text-transform: uppercase; display: block; margin-top: 12px; margin-bottom: 4px; border-bottom: 2px solid var(--brand-gold); font-size: 9.5pt; }
        
        .signatures { display: flex; justify-content: space-between; margin-top: 40px; gap: 80px; }
        .sign-box { flex: 1; border-top: 2px solid var(--brand-dark); text-align: center; padding-top: 8px; font-weight: 700; font-size: 9pt; }

        @media print {
            body { background: white; padding: 0; margin: 0; }
            #login-overlay, .nav-bar, .control-panel, #dashboard-panel, #client-db-panel, .no-print { display: none !important; }
            .document-page { display: block !important; box-shadow: none; margin: 0; width: 100%; page-break-after: always; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <img src="chiwowow 2.png" alt="Logo" class="login-logo">
            <h3 style="font-family:'Montserrat'; font-weight: 800; color: var(--brand-dark);">SISTEMA DE EXPEDIENTES</h3>
            <input type="password" id="pass" style="text-align:center;" placeholder="Contrase√±a de Acceso">
            <button class="btn-action" onclick="entrar()">INGRESAR AL PANEL</button>
        </div>
    </div>

    <div class="main-container" id="sistema">
        
        <div class="nav-bar">
            <button class="nav-btn active" id="btn-nuevo" onclick="limpiarYMostrarNuevo()">üìù Nueva Venta / Abono</button>
            <button class="nav-btn" id="btn-historial" onclick="mostrarSeccion('historial')">üìä Historial de Expedientes</button>
            <button class="nav-btn crm-btn" id="btn-clientes" onclick="mostrarSeccion('clientes')">üë• CRM Clientes</button>
        </div>

        <div class="control-panel" id="input-form">
            <h2 class="panel-title">Gesti√≥n de Reservaciones</h2>
            <input type="hidden" id="edit_id">

            <div class="form-grid">
                <div><label>Nombre del Titular</label><input type="text" id="in_nombre"></div>
                <div><label>Tel√©fono</label><input type="text" id="in_tel"></div>
                <div><label>Email de Contacto</label><input type="text" id="in_email"></div>
            </div>

            <div class="form-grid">
                <div>
                    <label>Servicio / Destino</label>
                    <select id="in_servicio" onchange="toggleOtroServicio(this)">
                        <option>Expedici√≥n Creel y Chepe</option>
                        <option>Huasteca Potosina</option>
                        <option>Renta Crafter 2025</option>
                        <option>Sierra Tarahumara Especial</option>
                        <option value="OTRO">OTRO (Escribir manualmente...)</option>
                    </select>
                    <input type="text" id="in_servicio_otro" placeholder="Escribe el destino aqu√≠..." style="display:none; margin-top:10px; background:#F4F6F7;">
                </div>
                <div><label>Fechas del Viaje</label><input type="text" id="in_fechas" placeholder="Ej: 15 al 20 de Julio"></div>
                <div><label>Costo Total Acordado ($)</label><input type="number" id="in_total" placeholder="0.00"></div>
            </div>

            <div class="abono-section">
                <div class="form-grid">
                    <div><label>Monto a Abonar Hoy ($)</label><input type="number" id="in_abono_nuevo" placeholder="0.00"></div>
                    <div><label>M√©todo de Pago</label>
                        <select id="in_metodo">
                            <option>Transferencia</option>
                            <option>Efectivo</option>
                            <option>Tarjeta Cr√©dito/D√©bito</option>
                            <option>Dep√≥sito OXXO/Bancario</option>
                        </select>
                    </div>
                    <div><label>Fecha de Recibo</label><input type="date" id="in_fecha_pago"></div>
                </div>
            </div>

            <button class="btn-action" onclick="guardar()">Guardar Expediente y Generar Documentos</button>
            <button id="btn-cancel" class="btn-action" style="background:#7F8C8D; display:none;" onclick="limpiarYMostrarNuevo()">Cancelar Edici√≥n</button>
        </div>

        <div id="dashboard-panel" style="display:none;">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color:white; margin:0;">Archivo Maestro de Ventas</h3>
                <div style="display:flex; gap:10px;">
                    <button class="nav-btn" style="background:var(--success)" onclick="descargarRespaldo()">üíæ Backup JSON</button>
                    <button class="nav-btn" style="background:var(--brand-gold)" onclick="document.getElementById('input-restore').click()">‚¨ÜÔ∏è Restaurar Base</button>
                    <input type="file" id="input-restore" style="display:none" accept=".json" onchange="cargarRespaldo(this)">
                </div>
            </div>
            <div class="db-table-container">
                <table class="db-table">
                    <thead><tr><th>Folio</th><th>Cliente / Destino</th><th>Total</th><th>Abonos</th><th>Saldo</th><th>Acciones</th></tr></thead>
                    <tbody id="tabla-body"></tbody>
                </table>
            </div>
        </div>

        <div id="client-db-panel" style="display:none;">
            <h2 class="panel-title" style="color:white;">Directorio CRM de Clientes</h2>
            <div class="db-table-container">
                <table class="db-table">
                    <thead><tr><th>Titular</th><th>Tel√©fono</th><th>Email</th><th>Viajes Realizados</th><th>Acciones</th></tr></thead>
                    <tbody id="tabla-crm-body"></tbody>
                </table>
            </div>
        </div>

        <div id="receipt-document" class="document-page">
            <div class="header-doc">
                <img src="chiwowow 2.png" class="logo-doc">
                <div style="text-align:right;">
                    <h1 style="margin:0; font-family:'Montserrat'; font-size: 20pt; color: var(--brand-dark);">RECIBO DE PAGO</h1>
                    <p id="out_folio" style="color:var(--brand-gold); font-weight:800; font-size:1.5rem; margin:0;"></p>
                </div>
            </div>
            <div style="margin-bottom: 25px; padding: 15px; background: #F8F9F9; border-radius: 8px;">
                <p><strong>CLIENTE:</strong> <span id="out_cliente"></span> | <strong>DESTINO:</strong> <span id="out_servicio"></span></p>
                <p><strong>FECHAS:</strong> <span id="out_fechas_doc"></span></p>
            </div>
            <table style="width:100%; border-collapse:collapse; margin-top:10px;">
                <thead style="background:var(--brand-dark); color:white;">
                    <tr><th style="padding:10px; text-align:left;">Fecha</th><th style="padding:10px; text-align:left;">M√©todo</th><th style="padding:10px; text-align:right;">Monto</th></tr>
                </thead>
                <tbody id="out_abonos_recibo"></tbody>
            </table>
            <div style="text-align:right; margin-top:25px; border-top:4px solid var(--brand-gold); padding-top:15px;">
                <p>COSTO TOTAL: <span id="out_total"></span> | TOTAL ABONADO: <span id="out_pagado"></span></p>
                <p style="color:var(--danger); font-weight:900; font-size:1.5rem; background:#FDEDEC; padding:10px; display:inline-block;">SALDO PENDIENTE: <span id="out_saldo"></span></p>
            </div>
            <div class="no-print" style="margin-top:40px; text-align:center;">
                <button class="btn-action" style="width:auto; padding:15px 50px;" onclick="window.print()">üñ®Ô∏è IMPRIMIR EXPEDIENTE</button>
                <button class="btn-action" style="width:auto; padding:15px 50px; background:#7F8C8D;" onclick="mostrarSeccion('historial')">VOLVER AL PANEL</button>
            </div>
        </div>

        <div id="contract-document" class="document-page">
            <div class="header-doc" style="border-bottom: 2px solid var(--brand-gold);">
                <img src="chiwowow 2.png" style="max-height: 50px;">
                <h2 style="margin:0; font-family:'Montserrat'; font-size: 14pt;">CONTRATO DE ADHESI√ìN Y SERVICIOS</h2>
            </div>
            <div class="contract-text">
                <p>Contrato que celebran por una parte <strong>CHIWOW-WOW ADVENTURE & TRAVEL</strong> (LA EMPRESA) y por la otra el Sr./Sra. <strong id="out_cliente_con"></strong> (EL CLIENTE).</p>

                <span class="clause-title">1. RESERVACIONES, ANTICIPOS Y LIQUIDACI√ìN</span>
                <p>EL CLIENTE acepta que todo anticipo o pago realizado es <strong>ESTRICTAMENTE NO REEMBOLSABLE</strong>. El saldo total del viaje deber√° estar liquidado al 100% al menos 72 horas antes de la salida programada.</p>

                <span class="clause-title">2. RESPONSABILIDAD DE TERCEROS (DESLINDE)</span>
                <p>LA EMPRESA act√∫a como intermediario log√≠stico. No se hace responsable por accidentes, lesiones, enfermedades, robos o deficiencias en el servicio ocurridos dentro de instalaciones de terceros tales como: <strong>hoteles, restaurantes, parques de aventura, telef√©ricos, aerol√≠neas o gu√≠as locales</strong>. Cualquier reclamaci√≥n deber√° tratarse directamente con el establecimiento responsable.</p>

                <span class="clause-title">3. FUERZA MAYOR Y CONTINGENCIAS</span>
                <p>No somos responsables por retrasos, cancelaciones o cambios de itinerario derivados de: clima adverso, bloqueos carreteros, fallas en el Tren Chepe, huelgas o pandemias. En estos casos, se emitir√° un certificado de viaje para reprogramaci√≥n seg√∫n disponibilidad; <strong>no se realizar√°n reembolsos en efectivo</strong>.</p>

                <span class="clause-title">4. EQUIPAJE Y OBJETOS PERSONALES</span>
                <p>EL CLIENTE es el √∫nico responsable de su equipaje y art√≠culos de valor. LA EMPRESA no responde por p√©rdidas, robos o da√±os de maletas o dispositivos electr√≥nicos durante el trayecto o estancias.</p>

                <span class="clause-title">5. CONDUCTA Y DERECHO DE ADMISI√ìN</span>
                <p>Queda prohibido el consumo de sustancias ilegales o alcohol excesivo en la unidad. EL CLIENTE que ponga en riesgo la seguridad o armon√≠a del grupo ser√° retirado del tour sin derecho a reembolso ni transporte de regreso.</p>

                <span class="clause-title">6. AVISO DE PRIVACIDAD Y USO DE IMAGEN</span>
                <p>EL CLIENTE autoriza el uso de fotos o videos capturados durante el viaje para fines promocionales de LA EMPRESA en redes sociales y publicidad oficial.</p>
            </div>
            <div class="signatures">
                <div class="sign-box">CHI-WOW-WOW ADVENTURE & TRAVEL<br><small>FIRMA Y SELLO</small></div>
                <div class="sign-box">ACEPTO DE CONFORMIDAD<br><small>FIRMA DEL CLIENTE TITULAR</small></div>
            </div>
        </div>

    </div>

    <script>
        document.getElementById('in_fecha_pago').valueAsDate = new Date();

        function entrar() {
            if(document.getElementById('pass').value.toLowerCase() === "grchiwowow") {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('sistema').style.display = 'block';
                cargarVentas();
            }
        }

        function toggleOtroServicio(select) {
            document.getElementById('in_servicio_otro').style.display = (select.value === 'OTRO') ? 'block' : 'none';
        }

        function cargarVentas() {
            let registros = JSON.parse(localStorage.getItem('chiwowow_ventas')) || [];
            let tbody = document.getElementById('tabla-body');
            tbody.innerHTML = "";
            let fmt = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });

            registros.forEach(reg => {
                let pagado = reg.abonos.reduce((s, a) => s + (parseFloat(a.monto) || 0), 0);
                let saldo = reg.total - pagado;
                let abonosHtml = reg.abonos.map(a => `<span class="abono-tag">${a.fecha}: ${fmt.format(a.monto)}</span>`).join("");

                tbody.insertAdjacentHTML('beforeend', `
                    <tr>
                        <td><strong>${reg.folio}</strong></td>
                        <td>${reg.nombre}<br><small>${reg.servicio}</small></td>
                        <td>${fmt.format(reg.total)}</td>
                        <td>${abonosHtml}</td>
                        <td style="color:red; font-weight:bold;">${fmt.format(saldo)}</td>
                        <td>
                            <button class="btn-edit" onclick="prepararAbono('${reg.id}')">‚úèÔ∏è</button>
                            <button class="btn-delete" onclick="borrarVenta('${reg.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `);
            });
        }

        function borrarVenta(id) {
            if(confirm("¬øEliminar este folio permanentemente?")) {
                let regs = JSON.parse(localStorage.getItem('chiwowow_ventas')) || [];
                let filtrados = regs.filter(r => r.id.toString() !== id.toString());
                localStorage.setItem('chiwowow_ventas', JSON.stringify(filtrados));
                cargarVentas();
            }
        }

        function borrarCliente(nombre) {
            if(confirm(`¬øDeseas eliminar a ${nombre} y todos sus registros?`)) {
                let regs = JSON.parse(localStorage.getItem('chiwowow_ventas')) || [];
                let filtrados = regs.filter(r => r.nombre !== nombre);
                localStorage.setItem('chiwowow_ventas', JSON.stringify(filtrados));
                cargarCRM();
            }
        }

        function guardar() {
            let id = document.getElementById('edit_id').value;
            let registros = JSON.parse(localStorage.getItem('chiwowow_ventas')) || [];
            let montoN = parseFloat(document.getElementById('in_abono_nuevo').value) || 0;
            let servicio = document.getElementById('in_servicio').value === 'OTRO' ? document.getElementById('in_servicio_otro').value : document.getElementById('in_servicio').value;

            if(id) {
                let r = registros.find(x => x.id == id);
                if(montoN > 0) r.abonos.push({monto: montoN, fecha: document.getElementById('in_fecha_pago').value, metodo: document.getElementById('in_metodo').value});
                r.nombre = document.getElementById('in_nombre').value;
                r.tel = document.getElementById('in_tel').value;
                r.email = document.getElementById('in_email').value;
                r.total = parseFloat(document.getElementById('in_total').value);
                r.fechas = document.getElementById('in_fechas').value;
                r.servicio = servicio;
            } else {
                let nuevo = {
                    id: Date.now().toString(),
                    folio: "CWW-" + Math.floor(10000 + Math.random()*90000),
                    nombre: document.getElementById('in_nombre').value,
                    tel: document.getElementById('in_tel').value,
                    email: document.getElementById('in_email').value,
                    servicio: servicio,
                    fechas: document.getElementById('in_fechas').value,
                    total: parseFloat(document.getElementById('in_total').value) || 0,
                    abonos: montoN > 0 ? [{monto: montoN, fecha: document.getElementById('in_fecha_pago').value, metodo: document.getElementById('in_metodo').value}] : []
                };
                registros.push(nuevo);
                id = nuevo.id;
            }
            localStorage.setItem('chiwowow_ventas', JSON.stringify(registros));
            verDocumentos(id);
        }

        function verDocumentos(id) {
            let reg = JSON.parse(localStorage.getItem('chiwowow_ventas')).find(x => x.id == id);
            document.getElementById('out_folio').innerText = reg.folio;
            document.getElementById('out_cliente').innerText = reg.nombre;
            document.getElementById('out_cliente_con').innerText = reg.nombre;
            document.getElementById('out_servicio').innerText = reg.servicio;
            document.getElementById('out_fechas_doc').innerText = reg.fechas;
            
            let html = "", pagado = 0, fmt = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });
            reg.abonos.forEach(a => {
                pagado += a.monto;
                html += `<tr><td>${a.fecha}</td><td>${a.metodo}</td><td style="text-align:right;">${fmt.format(a.monto)}</td></tr>`;
            });
            document.getElementById('out_abonos_recibo').innerHTML = html;
            document.getElementById('out_total').innerText = fmt.format(reg.total);
            document.getElementById('out_pagado').innerText = fmt.format(pagado);
            document.getElementById('out_saldo').innerText = fmt.format(reg.total - pagado);
            
            mostrarSeccion('none');
            document.getElementById('receipt-document').style.display = 'block';
            document.getElementById('contract-document').style.display = 'block';
        }

        function prepararAbono(id) {
            let reg = JSON.parse(localStorage.getItem('chiwowow_ventas')).find(x => x.id == id);
            document.getElementById('edit_id').value = reg.id;
            document.getElementById('in_nombre').value = reg.nombre;
            document.getElementById('in_tel').value = reg.tel;
            document.getElementById('in_email').value = reg.email;
            document.getElementById('in_total').value = reg.total;
            document.getElementById('in_fechas').value = reg.fechas;
            document.getElementById('btn-cancel').style.display = 'block';
            mostrarSeccion('nuevo');
        }

        function mostrarSeccion(s) {
            ['input-form', 'dashboard-panel', 'client-db-panel', 'receipt-document', 'contract-document'].forEach(d => document.getElementById(d).style.display = 'none');
            if(s === 'nuevo') document.getElementById('input-form').style.display = 'block';
            if(s === 'historial') { document.getElementById('dashboard-panel').style.display = 'block'; cargarVentas(); }
            if(s === 'clientes') { document.getElementById('client-db-panel').style.display = 'block'; cargarCRM(); }
        }

        function cargarCRM() {
            let regs = JSON.parse(localStorage.getItem('chiwowow_ventas')) || [];
            let tbody = document.getElementById('tabla-crm-body');
            tbody.innerHTML = "";
            let clientes = {};

            regs.forEach(r => {
                if(!clientes[r.nombre]) clientes[r.nombre] = {tel: r.tel, email: r.email, viajes: []};
                clientes[r.nombre].viajes.push(r.servicio);
            });

            for(let n in clientes) {
                tbody.insertAdjacentHTML('beforeend', `<tr>
                    <td>${n}</td><td>${clientes[n].tel}</td><td>${clientes[n].email}</td><td>${clientes[n].viajes.join(", ")}</td>
                    <td><button class="btn-delete" onclick="borrarCliente('${n}')">üóëÔ∏è</button></td>
                </tr>`);
            }
        }

        function descargarRespaldo() {
            let data = localStorage.getItem('chiwowow_ventas');
            let a = document.createElement("a");
            a.href = URL.createObjectURL(new Blob([data], {type: "application/json"}));
            a.download = "RESPALDO_CHI_WOW.json"; a.click();
        }

        function cargarRespaldo(input) {
            let reader = new FileReader();
            reader.onload = (e) => {
                localStorage.setItem('chiwowow_ventas', e.target.result);
                location.reload();
            };
            reader.readAsText(input.files[0]);
        }

        function limpiarYMostrarNuevo() {
            document.getElementById('edit_id').value = "";
            document.getElementById('in_nombre').value = "";
            document.getElementById('in_abono_nuevo').value = "";
            document.getElementById('in_servicio_otro').style.display = 'none';
            document.getElementById('btn-cancel').style.display = 'none';
            mostrarSeccion('nuevo');
        }
    </script>
</body>
</html>

