<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Chi-Wow-Wow (Control de Abonos)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Open+Sans:wght@400;600&display=swap');

        /* --- ESTILOS GENERALES --- */
        :root { --brand-dark: #1B2631; --brand-gold: #D4AF37; --text-main: #2C3E50; --bg-light: #F4F6F6; --success: #27ae60; --danger: #c0392b; --warning: #f39c12; }
        body { font-family: 'Open Sans', sans-serif; background-color: #525659; margin: 0; padding: 20px; color: var(--text-main); }

        /* --- PANTALLA DE BLOQUEO (LOGIN) --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #1B2631; z-index: 10000;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 12px;
            text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); width: 90%; max-width: 320px;
        }
        .login-logo { max-width: 140px; margin-bottom: 20px; }
        .login-input {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #ddd;
            border-radius: 6px; text-align: center; font-size: 16px; box-sizing: border-box;
        }
        .login-btn {
            background-color: #D4AF37; color: white; border: none; padding: 12px;
            width: 100%; font-weight: bold; border-radius: 6px; cursor: pointer; font-size: 16px;
        }
        .error-msg { color: #e74c3c; font-weight: bold; font-size: 13px; margin-top: 15px; display: none; }

        /* --- SISTEMA PRINCIPAL --- */
        .main-container { max-width: 1100px; margin: 0 auto; display: none; }

        /* --- NAVEGACI√ìN SUPERIOR --- */
        .nav-bar { display: flex; gap: 10px; margin-bottom: 20px; justify-content: flex-end; }
        .nav-btn { background: #34495e; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; }
        .nav-btn.active { background: #D4AF37; }

        /* --- CONTROLES Y FORMULARIO --- */
        .control-panel { background: white; padding: 25px; border-radius: 12px; margin-bottom: 40px; border-top: 6px solid var(--brand-dark); }
        .panel-title { font-family: 'Montserrat', sans-serif; font-weight: 700; color: var(--brand-dark); text-align: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .alert-edit-mode { 
            background-color: #fcf3cf; color: #7d6608; border: 1px solid #f1c40f; 
            padding: 10px; border-radius: 5px; margin-bottom: 15px; text-align: center; font-weight: bold; display: none; 
        }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 5px; text-transform: uppercase; color: #777; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        .btn-action { background-color: var(--brand-dark); color: white; border: none; padding: 15px; width: 100%; font-weight: 700; border-radius: 6px; cursor: pointer; text-transform: uppercase; margin-top: 10px; transition: 0.3s; }
        .btn-action.update-mode { background-color: var(--brand-gold); color: #1B2631; }
        
        .btn-cancel { background-color: #95a5a6; color: white; border: none; padding: 10px; width: 100%; font-weight: 600; border-radius: 6px; cursor: pointer; margin-top: 10px; display: none; }

        /* --- DASHBOARD / HISTORIAL --- */
        #dashboard-panel { display: none; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; text-align: center; border-left: 5px solid var(--brand-gold); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-number { font-size: 24px; font-weight: 800; color: var(--brand-dark); display: block; }
        .stat-label { font-size: 12px; color: #777; text-transform: uppercase; font-weight: 600; }

        .db-table-container { overflow-x: auto; background: white; border-radius: 8px; padding: 15px; }
        .db-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .db-table th { background: var(--brand-dark); color: white; padding: 12px; text-align: left; }
        .db-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .db-table tr:hover { background-color: #f9f9f9; }
        
        .status-paid { background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; }
        .status-pending { background: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; }
        
        .btn-icon { border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; margin-right: 5px; color: white; }
        .btn-delete { background: #e74c3c; }
        .btn-edit { background: #f39c12; }
        .btn-export { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600; margin-bottom: 10px; }

        /* --- HOJAS DE DOCUMENTO --- */
        .document-page { 
            display: none; 
            background: white; 
            width: 21.59cm; 
            height: 27.94cm; /* Carta exacta */
            margin: 0 auto 40px auto; 
            padding: 1.5cm 2cm; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            box-sizing: border-box; 
            position: relative; 
            overflow: hidden; 
        }

        /* HEADER GENERAL */
        header { display: flex; justify-content: space-between; border-bottom: 3px solid var(--brand-dark); padding-bottom: 15px; margin-bottom: 25px; }
        .logo-img { max-width: 130px; margin-bottom: 5px; }
        .company-branding h1 { font-family: 'Montserrat', sans-serif; font-size: 18px; color: var(--brand-dark); margin: 0; text-transform: uppercase; font-weight: 700; }
        .fiscal-details { font-size: 0.7rem; color: #7F8C8D; line-height: 1.4; margin-top: 5px; }

        /* RECIBO */
        .info-columns { display: flex; gap: 20px; background: var(--bg-light); padding: 15px; margin-bottom: 25px; border-radius: 8px; }
        .info-box { flex: 1; }
        .concept-table { width: 100%; border-collapse: separate; margin-bottom: 25px; border-spacing: 0; border: 1px solid #eee; border-radius: 8px; }
        .concept-table th { background: var(--brand-dark); color: white; padding: 10px; text-align: left; font-size: 0.8rem; font-weight: 600; }
        .concept-table td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        
        /* CONTRATO (CL√ÅUSULAS ORIGINALES) */
        #contract-document.flex-mode { display: flex !important; flex-direction: column; justify-content: space-between; }
        .contract-header-flex { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid var(--brand-gold); padding-bottom: 10px; margin-bottom: 15px; }
        .contract-logo { max-height: 50px; width: auto; margin-bottom: 5px; }
        .contract-meta-box { display: flex; justify-content: space-between; font-size: 9pt; margin-bottom: 15px; background: var(--bg-light); padding: 8px 12px; border-radius: 4px; border-left: 4px solid var(--brand-dark); }
        .contract-body { font-size: 9pt; text-align: justify; line-height: 1.3; color: #333; flex-grow: 1; }
        .contract-clause { margin-bottom: 8px; } 
        .clause-title { color: var(--brand-dark); font-family: 'Montserrat', sans-serif; font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 2px; font-size: 9.5pt; border-bottom: 1px solid #ccc; }
        .sub-clause { margin-bottom: 2px; padding-left: 0; position: relative; }
        .sub-clause strong { color: var(--brand-dark); font-weight: 600; }
        
        .bottom-section { margin-top: 10px; padding-top: 5px; }
        .manual-space-indicator { height: 30px; border-bottom: 1px dashed #ddd; margin-bottom: 10px; }
        .legal-footer { margin-bottom: 10px; font-size: 7.5pt; color: #555; text-align: justify; border-top: 1px solid #eee; padding-top: 5px; }
        .acceptance-text { text-align: center; margin: 10px 0; font-weight: 700; font-size: 8.5pt; color: var(--brand-dark); text-transform: uppercase; letter-spacing: 0.5px; }
        .signatures { display: flex; justify-content: space-between; gap: 40px; margin-top: 5px; margin-bottom: 20px; }
        .sign-box { flex: 1; border-top: 1px solid var(--brand-dark); text-align: center; padding-top: 5px; font-size: 8pt; font-family: 'Montserrat', sans-serif; font-weight: 700; color: var(--brand-dark); }

        .controls { text-align: center; margin-top: 30px; display: flex; justify-content: center; gap: 20px; padding-bottom: 50px; }
        .btn-secondary { background: #95a5a6; color: white; border: none; padding: 15px 25px; border-radius: 6px; cursor: pointer; font-weight: 600; font-family: 'Montserrat'; }

        /* IMPRESI√ìN */
        @media print {
            body { background: white; padding: 0; margin: 0; }
            #login-overlay, .control-panel, .controls, .nav-bar, #dashboard-panel { display: none !important; }
            .main-container { display: block !important; margin: 0; width: 100%; max-width: none; }
            .document-page { display: block; width: 21.59cm; height: 27.94cm; margin: 0; padding: 1.5cm 2cm; page-break-after: always; box-shadow: none; overflow: hidden; }
            .document-page:last-child { page-break-after: avoid; }
            #contract-document { display: flex !important; flex-direction: column; justify-content: space-between; }
            .manual-space-indicator::after { display: none; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <img src="chiwowow 2.png" alt="Logo" class="login-logo">
            <h3 style="margin: 0 0 15px 0; color:#1B2631; font-family:'Montserrat';">ACCESO SEGURO</h3>
            <input type="password" id="pass" class="login-input" placeholder="Contrase√±a">
            <button class="login-btn" onclick="entrar()">ENTRAR AL SISTEMA</button>
            <p id="aviso" class="error-msg">‚ùå Contrase√±a incorrecta</p>
        </div>
    </div>

    <div class="main-container" id="sistema">
        
        <div class="nav-bar">
            <button class="nav-btn active" id="btn-nuevo" onclick="limpiarYMostrarNuevo()">üìù Nuevo Recibo</button>
            <button class="nav-btn" id="btn-historial" onclick="mostrarSeccion('historial')">üìä Historial y Abonos</button>
        </div>

        <div class="control-panel" id="input-form">
            <h2 class="panel-title">Gestor de Ventas</h2>
            
            <div id="edit-alert" class="alert-edit-mode">
                ‚ö†Ô∏è EST√ÅS EDITANDO UN REGISTRO EXISTENTE. MODIFICA EL ABONO PARA ACTUALIZAR EL SALDO.
            </div>
            
            <input type="hidden" id="edit_id">

            <div class="form-grid">
                <div class="form-group">
                    <label>Nombre del Cliente (Titular)</label>
                    <input type="text" id="in_nombre" placeholder="Nombre completo">
                </div>
                <div class="form-group">
                    <label>Tel√©fono</label>
                    <input type="text" id="in_tel" placeholder="Contacto">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="in_email" placeholder="cliente@email.com">
                </div>
            </div>

            <div class="form-group">
                <label>Nombres de Acompa√±antes</label>
                <textarea id="in_acompanantes" rows="2" placeholder="Ej: Mar√≠a P√©rez, Juanito P√©rez (8 a√±os)..."></textarea>
            </div>

            <div class="form-grid">
                <div class="form-group" style="grid-column: span 2;">
                    <label>Servicio Contratado</label>
                    <select id="in_servicio" onchange="toggleOtro(this)">
                        <option value="Expedici√≥n Creel y Chepe">Expedici√≥n Creel y Chepe</option>
                        <option value="Viaje a la Huasteca Potosina">Viaje a la Huasteca Potosina</option>
                        <option value="Tour Barrancas del Cobre">Tour Barrancas del Cobre</option>
                        <option value="Renta de Van Sprinter">Renta de Van Sprinter</option>
                        <option value="Traslado Privado">Traslado Privado</option>
                        <option value="OTRO">OTRO (Escribir...)</option>
                    </select>
                    <input type="text" id="in_servicio_otro" style="display:none; margin-top:5px; background:#f0f0f0;" placeholder="Escriba el nombre del servicio...">
                </div>
                <div class="form-group">
                    <label>Fechas del Viaje</label>
                    <input type="text" id="in_fechas" placeholder="Ej. 12 al 15 Oct">
                </div>
                <div class="form-group">
                    <label>Pasajeros</label>
                    <input type="number" id="in_pax" value="1">
                </div>
            </div>

            <div class="form-group">
                <label>Notas / Observaciones</label>
                <textarea id="in_notas" rows="2"></textarea>
            </div>

            <div class="form-grid" style="border-top: 2px solid #eee; padding-top:20px; margin-top:20px;">
                <div class="form-group">
                    <label>Costo Total ($)</label>
                    <input type="number" id="in_total" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label style="color:#f39c12; font-weight:800;">Abono Acumulado ($)</label>
                    <input type="number" id="in_abono" placeholder="Suma total pagada hasta hoy" style="border: 2px solid #f39c12; background-color: #fef9e7;">
                    <small style="color:#777;">* Ingresa la suma TOTAL que ha pagado el cliente (Anterior + Nuevo abono)</small>
                </div>
                <div class="form-group">
                    <label>M√©todo de Pago (Actual)</label>
                    <select id="in_metodo">
                        <option>Transferencia Electr√≥nica</option>
                        <option>Dep√≥sito Bancario</option>
                        <option>Tarjeta de Cr√©dito/D√©bito</option>
                        <option>Efectivo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="color:#c0392b;">Fecha de Emisi√≥n</label>
                    <input type="date" id="in_fecha">
                </div>
            </div>

            <button id="btn-save" class="btn-action" onclick="generarYGuardar()">GUARDAR Y GENERAR</button>
            <button id="btn-cancel-edit" class="btn-cancel" onclick="limpiarYMostrarNuevo()">CANCELAR EDICI√ìN</button>
        </div>

        <div id="dashboard-panel">
            <h2 class="panel-title">Base de Datos y Abonos</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="stat-total-ventas">$0</span>
                    <span class="stat-label">Venta Total Acumulada</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-por-cobrar" style="color:#c0392b;">$0</span>
                    <span class="stat-label">Pendiente de Cobro</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-pasajeros">0</span>
                    <span class="stat-label">Pasajeros Totales</span>
                </div>
            </div>

            <button class="btn-export" onclick="exportarExcel()">üì• Descargar Excel</button>
            
            <div class="db-table-container">
                <table class="db-table" id="tabla-ventas">
                    <thead>
                        <tr>
                            <th>Recibo</th>
                            <th>Cliente</th>
                            <th>Pax</th>
                            <th>Total</th>
                            <th>Pagado</th>
                            <th>Resta</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>


        <div id="receipt-document" class="document-page">
            <header>
                <div class="company-branding">
                    <img src="chiwowow 2.png" alt="Logo" class="logo-img">
                    <h1>CHIWOW-WOW A & T</h1>
                    <div class="fiscal-details">
                        <strong>RAZ√ìN SOCIAL:</strong> CHIWOW-WOW A & T, S.A. DE C.V.<br>
                        <strong>RFC:</strong> CAT2205094P0<br>
                        Av. Heroico Colegio Militar #7716, Chihuahua, Chih.<br>
                        R√©gimen: Sociedad An√≥nima de Capital Variable
                    </div>
                </div>
                <div class="receipt-meta">
                    <div style="font-family:'Montserrat'; font-weight:700; font-size:24px; color:#1B2631; text-align:right;">RECIBO OFICIAL</div>
                    <div style="color:#D4AF37; font-weight:700; font-size:1.2rem; margin-top:5px; text-align:right;" id="out_folio">#00000</div>
                    <div style="font-size:0.9rem; margin-top:5px; text-align:right; color:#7F8C8D;">Fecha: <span id="out_fecha_emision"></span></div>
                </div>
            </header>

            <div class="info-columns">
                <div class="info-box">
                    <div style="font-family:'Montserrat'; font-size:0.8rem; text-transform:uppercase; color:#1B2631; font-weight:700; border-bottom:2px solid #D4AF37; margin-bottom:8px;">Datos del Cliente</div>
                    <p><strong id="out_cliente" style="font-size: 1.1rem;"></strong></p>
                    <p>Tel: <span id="out_tel"></span></p>
                    <p>Email: <span id="out_email"></span></p>
                    <p style="font-size:0.8rem; margin-top:5px; color:#555;"><strong>Acompa√±antes:</strong> <span id="out_acompanantes"></span></p>
                </div>
                <div class="info-box" style="border-left: 2px solid #eee; padding-left: 30px;">
                    <div style="font-family:'Montserrat'; font-size:0.8rem; text-transform:uppercase; color:#1B2631; font-weight:700; border-bottom:2px solid #D4AF37; margin-bottom:8px;">Detalles del Servicio</div>
                    <p><strong id="out_servicio" style="font-size: 1.1rem;"></strong></p>
                    <p>Fechas: <span id="out_fechas"></span></p>
                    <p>Pax: <span id="out_pax"></span> Personas</p>
                </div>
            </div>

            <table class="concept-table">
                <thead><tr><th style="width:55%;">Descripci√≥n</th><th style="width:25%;">M√©todo</th><th style="text-align:right; width:20%;">Importe</th></tr></thead>
                <tbody>
                    <tr>
                        <td>Costo Total del Servicio Tur√≠stico<br><small id="out_notas" style="font-style:italic; color:#7F8C8D;"></small></td>
                        <td style="text-align: center;">-</td>
                        <td style="text-align:right; font-weight:600;" id="out_total"></td>
                    </tr>
                    <tr>
                        <td>Abono a Cuenta Recibido (Total Acumulado)</td>
                        <td id="out_metodo" style="text-align: center;"></td>
                        <td style="text-align:right; color:#c0392b; font-weight:600;" id="out_abono"></td>
                    </tr>
                </tbody>
            </table>

            <div style="text-align:right; margin-left: auto; width: 300px;">
                <div style="font-size: 1.2rem; color: #1B2631; font-weight: 700; border-top: 3px solid #D4AF37; padding-top: 10px; text-align: right;">
                    Saldo Pendiente: <span id="out_saldo"></span>
                </div>
            </div>
            
            <div style="text-align:center; font-size:0.75rem; color:#7F8C8D; position: absolute; bottom: 40px; width: 85%; left: 50%; transform: translateX(-50%);">
                Este documento es un comprobante interno. Tel: 614 286 0572.
            </div>
        </div>

        <div id="contract-document" class="document-page">
            <div class="contract-header-flex">
                <div>
                    <img src="chiwowow 2.png" class="contract-logo">
                    <div style="font-family: 'Montserrat'; font-weight: 700; color: #1B2631; font-size: 12px;">CHIWOW-WOW A & T</div>
                </div>
                <div style="text-align:right;">
                    <div style="color: #1B2631; font-family: 'Montserrat'; font-size: 16px; font-weight: 700;">CONTRATO DE SERVICIOS</div>
                    <div style="font-family: 'Montserrat'; font-size: 10px; color: #D4AF37; font-weight: 700;">FOLIO: <span id="contrato_folio"></span></div>
                </div>
            </div>

            <div class="contract-meta-box">
                <div><span style="font-weight: 700; color: #7F8C8D;">TITULAR:</span> <span id="contrato_cliente" style="font-weight: 600; color: #1B2631;"></span></div>
                <div><span style="font-weight: 700; color: #7F8C8D;">FECHA:</span> <span id="contrato_fecha" style="font-weight: 600; color: #1B2631;"></span></div>
            </div>

            <div class="contract-body">
                <p style="margin-bottom: 10px;">Contrato de prestaci√≥n de servicios tur√≠sticos celebrado entre <strong>CHIWOW-WOW A & T, S.A. DE C.V.</strong> ("LA EMPRESA") y "EL CLIENTE", <strong>quien suscribe por s√≠ mismo y en representaci√≥n de sus acompa√±antes</strong>. Al realizar cualquier pago, las partes aceptan las siguientes cl√°usulas:</p>

                <div class="contract-clause">
                    <span class="clause-title">1. COMPROMISO Y GARANT√çA</span>
                    <div class="sub-clause"><strong>Calidad:</strong> Unidades garantizadas en √≥ptimas condiciones mec√°nicas, de limpieza e higiene, con A/C funcional.</div>
                    <div class="sub-clause"><strong>Seguridad Legal:</strong> Servicio por operadores con <strong>Licencia Federal vigente</strong>. Unidades con permisos federales, placas y <strong>P√≥liza de Seguro de Viajero</strong> con cobertura amplia para todos los ocupantes a bordo.</div>
                    <div class="sub-clause"><strong>Cumplimiento:</strong> Se respetar√°n itinerarios y horarios pactados, garantizando el servicio contratado (salvo fuerza mayor).</div>
                </div>

                <div class="contract-clause">
                    <span class="clause-title">2. PAGOS Y LIQUIDACI√ìN</span>
                    <div class="sub-clause"><strong>Anticipo:</strong> Todo anticipo, reserva o apartado es <strong>NO REEMBOLSABLE</strong>. Garantiza la disponibilidad y gastos administrativos.</div>
                    <div class="sub-clause"><strong>Liquidaci√≥n:</strong> El servicio debe liquidarse al 100% al menos <strong>3 d√≠as (72 horas) antes</strong> del viaje. De no ser as√≠, se cancelar√° sin devoluci√≥n.</div>
                </div>

                <div class="contract-clause">
                    <span class="clause-title">3. POL√çTICAS DE CANCELACI√ìN</span>
                    <div class="sub-clause"><strong>Por el Cliente:</strong> Si cancela o no se presenta (<strong>"No Show"</strong>), <strong>NO HABR√Å DEVOLUCIONES</strong>. El pago es pena convencional.</div>
                    <div class="sub-clause"><strong>Fuerza Mayor:</strong> Si el viaje no se realiza por causas ajenas a LA EMPRESA (clima, bloqueos, fallas), la √∫nica opci√≥n es <strong>CAMBIO DE FECHA</strong>. No hay reembolsos.</div>
                </div>

                <div class="contract-clause">
                    <span class="clause-title">4. REGLAMENTO, CONDUCTA Y RESPONSABILIDAD</span>
                    <div class="sub-clause"><strong>Prohibiciones:</strong> Estrictamente <strong>PROHIBIDO</strong> consumir alcohol, estupefacientes o fumar (incluyendo "vapes") dentro de la unidad.</div>
                    <div class="sub-clause"><strong>Responsabilidad:</strong> EL CLIENTE cubre de inmediato cualquier da√±o o suciedad excesiva causada por √©l o sus acompa√±antes.</div>
                    <div class="sub-clause"><strong>Autoridad:</strong> El operador puede bajar a cualquier persona con conducta agresiva o peligrosa, sin derecho a reembolso.</div>
                </div>

                <div class="contract-clause">
                    <span class="clause-title">5. LOG√çSTICA Y SEGURIDAD</span>
                    <div class="sub-clause"><strong>Tolerancia:</strong> M√°ximo <strong>10 minutos</strong> de tolerancia a la salida. Transcurrido este tiempo, la unidad partir√° sin responsabilidad.</div>
                    <div class="sub-clause"><strong>Seguro:</strong> Cubre exclusivamente mientras EL CLIENTE est√© a bordo. No cubre accidentes externos ni objetos olvidados.</div>
                </div>
            </div>

            <div class="bottom-section">
                <div class="manual-space-indicator"></div>
                <div class="legal-footer">
                    <strong>JURISDICCI√ìN:</strong> Para la interpretaci√≥n y cumplimiento de este contrato, las partes se someten a la jurisdicci√≥n de los tribunales de <strong>Chihuahua, Chih.</strong>, renunciando a cualquier otro fuero por raz√≥n de sus domicilios.
                </div>
                <div class="acceptance-text">LE√çDO LO ANTERIOR, ACEPTO INCONDICIONALMENTE LOS T√âRMINOS.</div>
                <div class="signatures">
                    <div class="sign-box">
                        <br><br><br>
                        FIRMA REPRESENTANTE<br>CHIWOW-WOW A & T
                    </div>
                    <div class="sign-box">
                        <br><br><br>
                        FIRMA CLIENTE TITULAR<br><span id="firma_nombre_cliente" class="sign-client-name"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls" id="btn-container">
            <button class="btn-action" style="width:auto; padding:15px 30px;" onclick="window.print()">üñ®Ô∏è IMPRIMIR / PDF</button>
            <button class="btn-secondary" onclick="editar()">‚úèÔ∏è CORREGIR VISTA PREVIA</button>
        </div>

    </div>

    <script>
        // --- FUNCI√ìN PARA ENTRAR (CONTRASE√ëA) ---
        function entrar() {
            var pass = document.getElementById('pass').value;
            var aviso = document.getElementById('aviso');

            if (pass.toLowerCase() === "grchiwowow") {
                document.getElementById('login-overlay').style.display = 'none'; 
                document.getElementById('sistema').style.display = 'block';     
                cargarHistorial(); 
            } else {
                aviso.style.display = 'block';
                document.getElementById('pass').value = ''; 
            }
        }
        document.getElementById('pass').addEventListener("keypress", function(e) {
            if (e.key === "Enter") entrar();
        });

        document.getElementById('in_fecha').valueAsDate = new Date();

        function toggleOtro(select) {
            var otroInput = document.getElementById('in_servicio_otro');
            otroInput.style.display = (select.value === 'OTRO') ? 'block' : 'none';
        }

        // --- NAVEGACI√ìN Y RESET ---
        function limpiarYMostrarNuevo() {
            // Limpia el formulario para un cliente nuevo
            document.getElementById('in_nombre').value = "";
            document.getElementById('in_tel').value = "";
            document.getElementById('in_email').value = "";
            document.getElementById('in_acompanantes').value = "";
            document.getElementById('in_fechas').value = "";
            document.getElementById('in_pax').value = "1";
            document.getElementById('in_notas').value = "";
            document.getElementById('in_total').value = "";
            document.getElementById('in_abono').value = "";
            document.getElementById('in_fecha').valueAsDate = new Date();
            
            // Quita modo edici√≥n
            document.getElementById('edit_id').value = "";
            document.getElementById('btn-save').innerText = "GUARDAR Y GENERAR";
            document.getElementById('btn-save').classList.remove("update-mode");
            document.getElementById('edit-alert').style.display = "none";
            document.getElementById('btn-cancel-edit').style.display = "none";

            mostrarSeccion('nuevo');
        }

        function mostrarSeccion(seccion) {
            const form = document.getElementById('input-form');
            const dash = document.getElementById('dashboard-panel');
            const doc1 = document.getElementById('receipt-document');
            const doc2 = document.getElementById('contract-document');
            const btns = document.getElementById('btn-container');

            doc1.style.display = 'none';
            doc2.style.display = 'none';
            btns.style.display = 'none';
            
            document.getElementById('btn-nuevo').classList.remove('active');
            document.getElementById('btn-historial').classList.remove('active');

            if (seccion === 'nuevo') {
                form.style.display = 'block';
                dash.style.display = 'none';
                document.getElementById('btn-nuevo').classList.add('active');
            } else {
                form.style.display = 'none';
                dash.style.display = 'block';
                document.getElementById('btn-historial').classList.add('active');
                cargarHistorial(); 
            }
        }

        // --- GENERAR Y GUARDAR (L√ìGICA ACTUALIZADA) ---
        function generarYGuardar() {
            // Datos del Formulario
            var nombre = document.getElementById('in_nombre').value || "Cliente General";
            var acompanantes = document.getElementById('in_acompanantes').value || "Sin acompa√±antes registrados";
            
            var editID = document.getElementById('edit_id').value; // ¬øEstamos editando?
            var folio = editID ? obtenerFolioPorID(editID) : "CWW-" + Math.floor(10000 + Math.random() * 90000); // Mismo folio si editas
            
            var fechaRaw = document.getElementById('in_fecha').value; 
            var partes = fechaRaw ? fechaRaw.split('-') : ["2026","01","01"];
            var fechaFmt = partes[2] + '/' + partes[1] + '/' + partes[0];

            var servicio = document.getElementById('in_servicio').value;
            if (servicio === 'OTRO') servicio = document.getElementById('in_servicio_otro').value;
            
            var fechasViaje = document.getElementById('in_fechas').value;
            var pax = parseInt(document.getElementById('in_pax').value) || 1;
            var notas = document.getElementById('in_notas').value;
            
            var total = parseFloat(document.getElementById('in_total').value) || 0;
            var abono = parseFloat(document.getElementById('in_abono').value) || 0;
            var saldo = total - abono;
            var metodo = document.getElementById('in_metodo').value;

            var registro = {
                id: editID ? parseInt(editID) : Date.now(),
                folio: folio,
                fechaEmision: fechaFmt,
                nombre: nombre,
                tel: document.getElementById('in_tel').value,
                email: document.getElementById('in_email').value,
                acompanantes: acompanantes,
                servicio: servicio,
                fechasViaje: fechasViaje,
                pax: pax,
                notas: notas,
                total: total,
                pagado: abono,
                saldo: saldo,
                estado: saldo <= 1 ? "LIQUIDADO" : "PENDIENTE"
            };

            guardarEnBD(registro); // Funci√≥n inteligente que decide si actualiza o crea
            llenarDocumentos(registro, notas, metodo);
        }

        function llenarDocumentos(data, notas, metodo) {
            document.getElementById('out_folio').innerText = data.folio;
            document.getElementById('out_fecha_emision').innerText = data.fechaEmision;
            document.getElementById('out_cliente').innerText = data.nombre;
            document.getElementById('out_tel').innerText = data.tel;
            document.getElementById('out_email').innerText = data.email;
            document.getElementById('out_acompanantes').innerText = data.acompanantes;
            
            document.getElementById('out_servicio').innerText = data.servicio;
            document.getElementById('out_fechas').innerText = data.fechasViaje;
            document.getElementById('out_pax').innerText = data.pax;
            document.getElementById('out_notas').innerText = notas ? "Nota: " + notas : "";

            var fmt = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });
            document.getElementById('out_total').innerText = fmt.format(data.total);
            document.getElementById('out_abono').innerText = "- " + fmt.format(data.pagado);
            document.getElementById('out_metodo').innerText = metodo;

            var divSaldo = document.getElementById('out_saldo');
            if(data.saldo <= 0.1) {
                divSaldo.innerHTML = "<span style='color:#27ae60'>" + fmt.format(0) + " (LIQUIDADO)</span>";
            } else {
                divSaldo.innerHTML = "<span style='color:#c0392b'>" + fmt.format(data.saldo) + "</span>";
            }

            // Llenar Contrato
            document.getElementById('contrato_folio').innerText = data.folio;
            document.getElementById('contrato_cliente').innerText = data.nombre;
            document.getElementById('contrato_fecha').innerText = data.fechaEmision;
            document.getElementById('firma_nombre_cliente').innerText = data.nombre;

            // Mostrar Vistas
            document.getElementById('input-form').style.display = 'none';
            document.getElementById('receipt-document').style.display = 'block';
            var contrato = document.getElementById('contract-document');
            contrato.style.display = 'block';
            contrato.classList.add('flex-mode');
            document.getElementById('btn-container').style.display = 'flex';
            window.scrollTo(0, 0);
        }

        function editar() {
            document.getElementById('input-form').style.display = 'block';
            document.getElementById('receipt-document').style.display = 'none';
            document.getElementById('contract-document').style.display = 'none';
            document.getElementById('btn-container').style.display = 'none';
            window.scrollTo(0, 0);
        }

        // --- L√ìGICA DE BASE DE DATOS Y EDICI√ìN ---
        function obtenerFolioPorID(id) {
            var registros = JSON.parse(localStorage.getItem('chiwowow_ventas')) || [];
            var encontrado = registros.find(r => r.id == id);
            return encontrado ? encontrado.folio : "ERR";
        }

        function guardarEnBD(registro) {
            var registros = JSON.parse(localStorage.getItem('chiwowow_ventas')) || [];
            
            // Buscar si ya existe (por ID)
            var index = registros.findIndex(r => r.id == registro.id);
            
            if (index !== -1) {
                // ACTUALIZAR EXISTENTE
                registros[index] = registro;
                alert("‚úÖ Abono/Actualizaci√≥n registrada correctamente.");
            } else {
                // CREAR NUEVO
                registros.push(registro);
                alert("‚úÖ Nueva venta registrada exitosamente.");
            }
            
            localStorage.setItem('chiwowow_ventas', JSON.stringify(registros));
        }

        // --- CARGAR DATOS EN EL FORMULARIO PARA EDITAR ---
        function cargarParaEditar(id) {
            var registros = JSON.parse(localStorage.getItem('chiwowow_ventas')) || [];
            var reg = registros.find(r => r.id == id);

            if(reg) {
                // Llenar campos
                document.getElementById('in_nombre').value = reg.nombre;
                document.getElementById('in_tel').value = reg.tel || "";
                document.getElementById('in_email').value = reg.email || "";
                document.getElementById('in_acompanantes').value = reg.acompanantes;
                document.getElementById('in_fechas').value = reg.fechasViaje;
                document.getElementById('in_pax').value = reg.pax;
                document.getElementById('in_notas').value = reg.notas || "";
                document.getElementById('in_total').value = reg.total;
                document.getElementById('in_abono').value = reg.pagado; // Aqu√≠ el usuario cambia el valor
                
                // Configurar Modo Edici√≥n
                document.getElementById('edit_id').value = reg.id;
                document.getElementById('in_servicio').value = reg.servicio; // Ojo si es "OTRO", habr√≠a que ajustar l√≥gica, pero por simplicidad
                
                // UI Changes
                mostrarSeccion('nuevo'); // Regresar al form
                document.getElementById('btn-save').innerText = "ACTUALIZAR RECIBO Y SALDO";
                document.getElementById('btn-save').classList.add("update-mode");
                document.getElementById('edit-alert').style.display = "block";
                document.getElementById('btn-cancel-edit').style.display = "block";
                
                window.scrollTo(0,0);
            }
        }

        function cargarHistorial() {
            var registros = JSON.parse(localStorage.getItem('chiwowow_ventas')) || [];
            var tbody = document.querySelector('#tabla-ventas tbody');
            tbody.innerHTML = ""; 

            var totalVentas = 0;
            var totalPendiente = 0;
            var totalPax = 0;
            var fmt = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });

            registros.slice().reverse().forEach((reg) => {
                totalVentas += reg.total;
                totalPendiente += reg.saldo;
                totalPax += reg.pax;

                var tr = document.createElement('tr');
                var claseEstado = reg.estado === 'LIQUIDADO' ? 'status-paid' : 'status-pending';

                tr.innerHTML = `
                    <td><strong>${reg.folio}</strong></td>
                    <td>${reg.nombre}</td>
                    <td style="text-align:center;">${reg.pax}</td>
                    <td>${fmt.format(reg.total)}</td>
                    <td>${fmt.format(reg.pagado)}</td>
                    <td style="color:${reg.saldo > 0 ? '#c0392b' : 'green'}">${fmt.format(reg.saldo)}</td>
                    <td><span class="${claseEstado}">${reg.estado}</span></td>
                    <td>
                        <button class="btn-icon btn-edit" title="Abonar / Editar" onclick="cargarParaEditar(${reg.id})">‚úèÔ∏è</button>
                        <button class="btn-icon btn-delete" title="Borrar" onclick="borrarRegistro(${reg.id})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('stat-total-ventas').innerText = fmt.format(totalVentas);
            document.getElementById('stat-por-cobrar').innerText = fmt.format(totalPendiente);
            document.getElementById('stat-pasajeros').innerText = totalPax;
        }

        function borrarRegistro(id) {
            if(confirm("¬øEst√°s seguro de borrar este registro permanentemente?")) {
                var registros = JSON.parse(localStorage.getItem('chiwowow_ventas')) || [];
                var nuevosRegistros = registros.filter(r => r.id !== id);
                localStorage.setItem('chiwowow_ventas', JSON.stringify(nuevosRegistros));
                cargarHistorial();
            }
        }

        function exportarExcel() {
            var registros = JSON.parse(localStorage.getItem('chiwowow_ventas')) || [];
            if(registros.length === 0) { alert("No hay datos para exportar"); return; }
            var csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Folio,Fecha,Cliente,Tel,Email,Destino,Fechas Viaje,Pax,Total,Pagado,Saldo,Estado\n";
            registros.forEach(function(row) {
                var limpioNombre = row.nombre.replace(/,/g, " ");
                var rowString = `${row.folio},${row.fechaEmision},${limpioNombre},${row.tel},${row.email},${row.servicio},${row.fechasViaje},${row.pax},${row.total},${row.pagado},${row.saldo},${row.estado}`;
                csvContent += rowString + "\n";
            });
            var encodedUri = encodeURI(csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Ventas_Chiwowow_" + new Date().toISOString().slice(0,10) + ".csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>

