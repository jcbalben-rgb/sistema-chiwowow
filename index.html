<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Chi-Wow-Wow PRO (Venta + CRM + Abonos)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Open+Sans:wght@400;600&display=swap');

        /* --- ESTILOS NUCLEO --- */
        :root { 
            --brand-dark: #1B2631; 
            --brand-gold: #D4AF37; 
            --success: #27ae60; 
            --danger: #c0392b; 
            --crm: #8e44ad;
        }
        body { font-family: 'Open Sans', sans-serif; background-color: #525659; margin: 0; padding: 20px; color: #2C3E50; }

        /* --- LOGIN --- */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #1B2631; z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { background: white; padding: 40px; border-radius: 12px; text-align: center; width: 90%; max-width: 320px; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 6px; text-align: center; }

        /* --- NAVEGACION --- */
        .main-container { max-width: 1200px; margin: 0 auto; display: none; }
        .nav-bar { display: flex; gap: 10px; margin-bottom: 20px; justify-content: flex-end; flex-wrap: wrap; }
        .nav-btn { background: #34495e; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; }
        .nav-btn.active { background: var(--brand-gold); color: #1B2631; }
        .nav-btn.crm { background: var(--crm); }

        /* --- PANELES --- */
        .control-panel { background: white; padding: 25px; border-radius: 12px; margin-bottom: 30px; border-top: 6px solid var(--brand-dark); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .panel-title { font-family: 'Montserrat'; font-weight: 700; text-align: center; margin-bottom: 20px; }
        .alert-edit { background: #fcf3cf; padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: center; font-weight: bold; display: none; }

        /* --- FORMULARIOS --- */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.75rem; font-weight: 700; color: #777; margin-bottom: 5px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .btn-action { background: var(--brand-dark); color: white; border: none; padding: 15px; width: 100%; font-weight: 700; border-radius: 6px; cursor: pointer; margin-top: 10px; }

        /* --- TABLAS Y STATS --- */
        .db-table-container { overflow-x: auto; background: white; border-radius: 8px; padding: 15px; }
        .db-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .db-table th { background: var(--brand-dark); color: white; padding: 12px; text-align: left; }
        .db-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .abono-tag { font-size: 0.7rem; background: #ebf5fb; color: #2e86c1; padding: 3px 6px; border-radius: 4px; display: block; margin-bottom: 3px; border-left: 3px solid #3498db; }

        /* --- DOCUMENTOS --- */
        .document-page { display: none; background: white; width: 21.59cm; margin: 0 auto 40px auto; padding: 1.5cm 2cm; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        @media print {
            #login-overlay, .nav-bar, .control-panel, .controls, #dashboard-panel, #client-db-panel { display: none !important; }
            .document-page { display: block !important; box-shadow: none; margin: 0; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h3 style="font-family:'Montserrat';">ACCESO CHIWOWOW</h3>
            <input type="password" id="pass" class="login-input" placeholder="Contrase√±a">
            <button class="btn-action" onclick="entrar()">ENTRAR</button>
        </div>
    </div>

    <div class="main-container" id="sistema">
        
        <div class="nav-bar">
            <button class="nav-btn active" id="btn-nuevo" onclick="limpiarYMostrarNuevo()">üìù Nueva Venta / Abono</button>
            <button class="nav-btn" id="btn-historial" onclick="mostrarSeccion('historial')">üìä Historial de Ventas</button>
            <button class="nav-btn crm" id="btn-clientes" onclick="mostrarSeccion('clientes')">üë• CRM Clientes</button>
        </div>

        <div class="control-panel" id="input-form">
            <h2 class="panel-title">Gesti√≥n de Ventas y Abonos</h2>
            <div id="edit-alert" class="alert-edit">‚ö†Ô∏è MODO EDICI√ìN/ABONO ACTIVO</div>
            <input type="hidden" id="edit_id">

            <div class="form-grid">
                <div class="form-group"><label>Titular</label><input type="text" id="in_nombre"></div>
                <div class="form-group"><label>Tel√©fono</label><input type="text" id="in_tel"></div>
                <div class="form-group"><label>Email</label><input type="text" id="in_email"></div>
            </div>

            <div class="form-group">
                <label>Acompa√±antes (1 por rengl√≥n)</label>
                <textarea id="in_acompanantes" rows="3"></textarea>
            </div>

            <div class="form-grid">
                <div class="form-group"><label>Servicio</label>
                    <select id="in_servicio">
                        <option>Expedici√≥n Creel y Chepe</option>
                        <option>Huasteca Potosina</option>
                        <option>Renta Crafter 2025</option>
                    </select>
                </div>
                <div class="form-group"><label>Fechas</label><input type="text" id="in_fechas"></div>
                <div class="form-group"><label>Pasajeros</label><input type="number" id="in_pax" value="1"></div>
            </div>

            <div class="form-grid" style="background:#fef9e7; padding:15px; border-radius:10px; border:1px solid #f1c40f;">
                <div class="form-group"><label>Costo Total ($)</label><input type="number" id="in_total"></div>
                <div class="form-group"><label style="color:var(--danger)">Monto a Abonar HOY ($)</label><input type="number" id="in_abono_nuevo" placeholder="0.00"></div>
                <div class="form-group"><label>M√©todo de Pago</label>
                    <select id="in_metodo">
                        <option>Transferencia</option>
                        <option>Efectivo</option>
                        <option>Tarjeta</option>
                    </select>
                </div>
                <div class="form-group"><label>Fecha Pago</label><input type="date" id="in_fecha_pago"></div>
            </div>

            <button id="btn-save" class="btn-action" onclick="generarYGuardar()">GUARDAR Y GENERAR DOCUMENTOS</button>
            <button id="btn-cancel" class="btn-action" style="background:#7f8c8d; display:none;" onclick="limpiarYMostrarNuevo()">CANCELAR EDICI√ìN</button>
        </div>

        <div id="dashboard-panel" style="display:none;">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn-action" style="background:var(--success)" onclick="exportarExcel()">üì• Descargar Excel Ventas</button>
                <button class="btn-action" style="background:#3498db" onclick="descargarRespaldo()">üíæ Backup JSON</button>
            </div>
            <div class="db-table-container">
                <table class="db-table" id="tabla-ventas">
                    <thead>
                        <tr>
                            <th>Folio</th>
                            <th>Cliente / Servicio</th>
                            <th>Total</th>
                            <th>Historial Abonos (Fecha - Monto - Tipo)</th>
                            <th>Saldo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="client-db-panel" style="display:none;">
            <h2 class="panel-title">üë• Base de Datos CRM</h2>
            <button class="btn-action" style="background:var(--crm); margin-bottom:15px;" onclick="exportarClientesExcel()">üì• Exportar Lista Marketing</button>
            <div class="db-table-container">
                <table class="db-table" id="tabla-clientes">
                    <thead>
                        <tr>
                            <th>Nombre Titular</th>
                            <th>Tel√©fono</th>
                            <th>Email</th>
                            <th>Historial de Viajes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="receipt-document" class="document-page">
            <div style="display:flex; justify-content:space-between; border-bottom:3px solid var(--brand-dark); padding-bottom:15px;">
                <div>
                    <h1 style="margin:0; font-family:'Montserrat'; color:var(--brand-dark);">CHIWOW-WOW A & T</h1>
                    <p style="font-size:0.8rem; color:#777;">RFC: CAT2205094P0 | Chihuahua, Chih.</p>
                </div>
                <div style="text-align:right;">
                    <h2 style="margin:0;">RECIBO OFICIAL</h2>
                    <p id="out_folio" style="color:var(--brand-gold); font-weight:800; font-size:1.2rem;"></p>
                </div>
            </div>
            
            <div class="form-grid" style="margin-top:20px; background:#f4f6f6; padding:15px; border-radius:8px;">
                <div><strong>CLIENTE:</strong> <span id="out_cliente"></span></div>
                <div><strong>SERVICIO:</strong> <span id="out_servicio"></span></div>
                <div><strong>FECHAS:</strong> <span id="out_fechas"></span></div>
            </div>

            <table style="width:100%; border-collapse:collapse; margin-top:30px;">
                <thead>
                    <tr style="background:var(--brand-dark); color:white;">
                        <th style="padding:10px; text-align:left;">Fecha</th>
                        <th style="padding:10px; text-align:left;">Descripci√≥n del Pago / M√©todo</th>
                        <th style="padding:10px; text-align:right;">Monto</th>
                    </tr>
                </thead>
                <tbody id="out_lista_abonos"></tbody>
            </table>

            <div style="margin-left:auto; width:250px; margin-top:20px; border-top:2px solid var(--brand-gold); padding-top:10px;">
                <div style="display:flex; justify-content:space-between;"><span>TOTAL:</span> <span id="out_total"></span></div>
                <div style="display:flex; justify-content:space-between; color:green;"><span>PAGADO:</span> <span id="out_pagado"></span></div>
                <div style="display:flex; justify-content:space-between; font-weight:800; color:red; font-size:1.1rem; margin-top:5px;"><span>SALDO:</span> <span id="out_saldo"></span></div>
            </div>

            <div class="controls" style="margin-top:40px; text-align:center;">
                <button class="btn-action" style="width:auto; padding:10px 40px;" onclick="window.print()">üñ®Ô∏è IMPRIMIR</button>
                <button class="btn-action" style="width:auto; padding:10px 40px; background:#7f8c8d;" onclick="mostrarSeccion('nuevo')">VOLVER</button>
            </div>
        </div>
    </div>

    <script>
        // --- LOGICA INICIAL ---
        document.getElementById('in_fecha_pago').valueAsDate = new Date();

        function entrar() {
            if (document.getElementById('pass').value.toLowerCase() === "grchiwowow") {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('sistema').style.display = 'block';
                cargarHistorial();
            }
        }

        function mostrarSeccion(s) {
            const secs = ['input-form', 'dashboard-panel', 'client-db-panel', 'receipt-document'];
            secs.forEach(id => document.getElementById(id).style.display = 'none');
            
            if (s === 'nuevo') document.getElementById('input-form').style.display = 'block';
            if (s === 'historial') { document.getElementById('dashboard-panel').style.display = 'block'; cargarHistorial(); }
            if (s === 'clientes') { document.getElementById('client-db-panel').style.display = 'block'; cargarCRM(); }
        }

        function limpiarYMostrarNuevo() {
            document.getElementById('edit_id').value = "";
            document.getElementById('in_nombre').value = "";
            document.getElementById('in_abono_nuevo').value = "";
            document.getElementById('edit-alert').style.display = 'none';
            document.getElementById('btn-cancel').style.display = 'none';
            document.getElementById('btn-save').innerText = "GUARDAR Y GENERAR DOCUMENTOS";
            mostrarSeccion('nuevo');
        }

        // --- CORE: GUARDAR Y ABONAR ---
        function generarYGuardar() {
            let id = document.getElementById('edit_id').value;
            let registros = JSON.parse(localStorage.getItem('chiwowow_ventas')) || [];
            
            let montoNuevo = parseFloat(document.getElementById('in_abono_nuevo').value) || 0;
            let fechaPago = document.getElementById('in_fecha_pago').value;
            let metodo = document.getElementById('in_metodo').value;

            let reg;
            if (id) {
                reg = registros.find(r => r.id == id);
                if (montoNuevo > 0) reg.abonos.push({ monto: montoNuevo, fecha: fechaPago, metodo: metodo });
                reg.nombre = document.getElementById('in_nombre').value;
                reg.tel = document.getElementById('in_tel').value;
                reg.email = document.getElementById('in_email').value;
                reg.acompanantes = document.getElementById('in_acompanantes').value;
                reg.total = parseFloat(document.getElementById('in_total').value);
            } else {
                reg = {
                    id: Date.now(),
                    folio: "CWW-" + Math.floor(10000 + Math.random() * 90000),
                    nombre: document.getElementById('in_nombre').value,
                    tel: document.getElementById('in_tel').value,
                    email: document.getElementById('in_email').value,
                    acompanantes: document.getElementById('in_acompanantes').value,
                    servicio: document.getElementById('in_servicio').value,
                    fechas: document.getElementById('in_fechas').value,
                    pax: document.getElementById('in_pax').value,
                    total: parseFloat(document.getElementById('in_total').value) || 0,
                    abonos: montoNuevo > 0 ? [{ monto: montoNuevo, fecha: fechaPago, metodo: metodo }] : []
                };
                registros.push(reg);
            }

            localStorage.setItem('chiwowow_ventas', JSON.stringify(registros));
            generarVistaRecibo(reg);
        }

        function generarVistaRecibo(reg) {
            document.getElementById('out_folio').innerText = reg.folio;
            document.getElementById('out_cliente').innerText = reg.nombre;
            document.getElementById('out_servicio').innerText = reg.servicio;
            document.getElementById('out_fechas').innerText = reg.fechas;
            
            let listaHtml = "";
            let pagado = 0;
            let fmt = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });

            reg.abonos.forEach(a => {
                pagado += a.monto;
                listaHtml += `<tr style="border-bottom:1px solid #eee;"><td style="padding:8px;">${a.fecha}</td><td style="padding:8px;">ABONO A CUENTA (${a.metodo})</td><td style="text-align:right; padding:8px;">${fmt.format(a.monto)}</td></tr>`;
            });

            document.getElementById('out_lista_abonos').innerHTML = listaHtml;
            document.getElementById('out_total').innerText = fmt.format(reg.total);
            document.getElementById('out_pagado').innerText = fmt.format(pagado);
            document.getElementById('out_saldo').innerText = fmt.format(reg.total - pagado);

            mostrarSeccion('none');
            document.getElementById('receipt-document').style.display = 'block';
        }

        // --- CARGAR HISTORIAL ---
        function cargarHistorial() {
            let registros = JSON.parse(localStorage.getItem('chiwowow_ventas')) || [];
            let tbody = document.querySelector('#tabla-ventas tbody');
            tbody.innerHTML = "";
            let fmt = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });

            registros.slice().reverse().forEach(reg => {
                let pagado = reg.abonos.reduce((acc, curr) => acc + curr.monto, 0);
                let saldo = reg.total - pagado;
                let abonosHtml = reg.abonos.map(a => `<span class="abono-tag">${a.fecha} | ${fmt.format(a.monto)} | ${a.metodo}</span>`).join("");

                let tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${reg.folio}</strong></td>
                    <td>${reg.nombre}<br><small>${reg.servicio} (${reg.fechas})</small></td>
                    <td>${fmt.format(reg.total)}</td>
                    <td>${abonosHtml || 'N/A'}</td>
                    <td style="color:red; font-weight:bold;">${fmt.format(saldo)}</td>
                    <td>${saldo <= 1 ? '‚úÖ' : '‚è≥'}</td>
                    <td>
                        <button onclick="prepararEdicion(${reg.id})">‚úèÔ∏è Abono</button>
                        <button onclick="borrar(${reg.id})" style="color:red">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- CRM LOGIC ---
        function cargarCRM() {
            let registros = JSON.parse(localStorage.getItem('chiwowow_ventas')) || [];
            let tbody = document.querySelector('#tabla-clientes tbody');
            tbody.innerHTML = "";
            let clientes = {};

            registros.forEach(r => {
                if(!clientes[r.nombre]) clientes[r.nombre] = { tel: r.tel, email: r.email, viajes: [] };
                clientes[r.nombre].viajes.push(r.servicio);
            });

            for (let nombre in clientes) {
                let c = clientes[nombre];
                let tr = document.createElement('tr');
                tr.innerHTML = `<td>${nombre}</td><td>${c.tel}</td><td>${c.email}</td><td><small>${c.viajes.join(", ")}</small></td>`;
                tbody.appendChild(tr);
            }
        }

        function prepararEdicion(id) {
            let registros = JSON.parse(localStorage.getItem('chiwowow_ventas')) || [];
            let reg = registros.find(r => r.id == id);
            document.getElementById('edit_id').value = reg.id;
            document.getElementById('in_nombre').value = reg.nombre;
            document.getElementById('in_tel').value = reg.tel;
            document.getElementById('in_total').value = reg.total;
            document.getElementById('edit-alert').style.display = 'block';
            document.getElementById('btn-cancel').style.display = 'block';
            mostrarSeccion('nuevo');
        }

        // --- EXPORTAR Y BACKUP ---
        function exportarExcel() {
            let registros = JSON.parse(localStorage.getItem('chiwowow_ventas')) || [];
            let csv = "Folio,Cliente,Servicio,Total,Saldo\n";
            registros.forEach(r => {
                let pagado = r.abonos.reduce((a, b) => a + b.monto, 0);
                csv += `${r.folio},${r.nombre},${r.servicio},${r.total},${r.total - pagado}\n`;
            });
            let blob = new Blob([csv], { type: 'text/csv' });
            let a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Ventas_Chiwowow.csv'; a.click();
        }

        function descargarRespaldo() {
            let data = localStorage.getItem('chiwowow_ventas');
            let blob = new Blob([data], {type: "application/json"});
            let a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "BACKUP_CHI_WOW.json"; a.click();
        }

        function borrar(id) { if(confirm("¬øEliminar?")) { 
            let regs = JSON.parse(localStorage.getItem('chiwowow_ventas'));
            localStorage.setItem('chiwowow_ventas', JSON.stringify(regs.filter(r => r.id != id)));
            cargarHistorial();
        }}
    </script>
</body>
</html>
