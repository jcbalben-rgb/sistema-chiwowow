<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Chi-Wow-Wow A&T</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Open+Sans:wght@400;600&display=swap');

        :root { 
            --brand-dark: #0D1B2A; 
            --brand-light: #1B263B;
            --brand-gold: #C5A022; 
            --success: #27ae60; 
            --danger: #c0392b; 
            --crm-bg: #512E5F; 
            --whatsapp: #25D366;
            --blue: #2980b9;
            --gray-bg: #f4f7f6;
            --text-main: #2C3E50;
            --card-shadow: 0 10px 25px rgba(0,0,0,0.08);
        }
        
        body { 
            font-family: 'Open Sans', sans-serif; 
            background-color: var(--gray-bg); 
            margin: 0; 
            padding: 30px; 
            color: var(--text-main); 
        }

        /* --- LOGIN --- */
        #login-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, var(--brand-dark) 0%, #162a42 100%);
            z-index: 10000; 
            display: flex; justify-content: center; align-items: center; 
        }
        .login-box { 
            background: white; padding: 50px 40px; border-radius: 20px; 
            text-align: center; width: 380px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
        }
        .login-logo { max-width: 180px; margin-bottom: 25px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1)); }

        /* --- LAYOUT GENERAL --- */
        .main-container { max-width: 1300px; margin: 0 auto; display: none; animation: fadeIn 0.5s ease-in-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- NAVEGACI√ìN --- */
        .nav-bar { display: flex; gap: 15px; margin-bottom: 30px; justify-content: flex-end; }
        .nav-btn { 
            background: white; color: var(--text-main); 
            padding: 14px 28px; border: none; border-radius: 12px; 
            cursor: pointer; font-weight: 700; font-family: 'Montserrat', sans-serif;
            text-transform: uppercase; font-size: 0.85rem; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.3s ease; 
            display: flex; align-items: center; gap: 8px;
        }
        .nav-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .nav-btn.active { 
            background: var(--brand-dark); color: white; 
            border-bottom: 4px solid var(--brand-gold); 
        }
        .nav-btn.crm-tab.active { background: var(--crm-bg); border-bottom: 4px solid #9b59b6; }

        /* --- PANELES --- */
        .card { 
            background: white; padding: 40px; border-radius: 20px; 
            margin-bottom: 40px; 
            box-shadow: var(--card-shadow);
            border-top: 6px solid var(--brand-gold);
        }
        .panel-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 30px; border-bottom: 2px solid #f0f0f0; padding-bottom: 20px; 
        }
        .panel-title { 
            font-family: 'Montserrat'; font-weight: 800; font-size: 1.5rem;
            color: var(--brand-dark); text-transform: uppercase; letter-spacing: -0.5px; margin: 0;
        }
        
        /* --- FORMULARIOS --- */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom: 25px; }
        label { 
            display: block; font-size: 0.75rem; font-weight: 700; color: #7f8c8d; 
            margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        input, select, textarea { 
            width: 100%; padding: 14px; border: 2px solid #eef2f5; 
            border-radius: 10px; font-size: 0.95rem; outline: none; 
            box-sizing: border-box; background: #fdfdfd;
            transition: all 0.3s;
            font-family: 'Open Sans', sans-serif;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--brand-gold); background: white;
            box-shadow: 0 0 0 4px rgba(197, 160, 34, 0.1);
        }
        
        .abono-box { 
            background: #fff9e6; padding: 25px; border-radius: 15px; 
            border: 1px dashed var(--brand-gold); margin-top: 30px; 
        }
        .abono-header { font-family: 'Montserrat'; font-weight: 700; color: #8a7019; margin: 0 0 15px 0; }

        /* --- TABLAS --- */
        .table-responsive { 
            overflow-x: auto; background: white; border-radius: 15px; 
            box-shadow: var(--card-shadow); border: 1px solid #f0f0f0;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.92rem; }
        th { 
            background: var(--brand-dark); color: white; padding: 18px; 
            text-align: left; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; 
        }
        td { padding: 18px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; color: #444; }
        tr:nth-child(even) { background-color: #fafbfc; }
        tr:hover { background-color: #f1f4f8; }
        
        .note-preview { 
            display: block; font-size: 0.8rem; color: #7F8C8D; 
            font-style: italic; margin-top: 6px; background: #f0f0f0;
            padding: 4px 8px; border-radius: 6px; display: inline-block;
        }
        .social-badge { 
            background: #e1f0fa; color: var(--blue); padding: 4px 10px; 
            border-radius: 20px; font-size: 0.75rem; font-weight: 700; 
            display: inline-flex; align-items: center; gap: 5px; margin-top: 5px; 
        }

        /* --- BOTONES Y HERRAMIENTAS --- */
        .btn-main { 
            background: var(--brand-dark); color: white; border: none; padding: 18px; 
            width: 100%; font-weight: 800; border-radius: 12px; cursor: pointer; 
            text-transform: uppercase; letter-spacing: 1px; transition: 0.3s;
            box-shadow: 0 5px 15px rgba(13, 27, 42, 0.2);
        }
        .btn-main:hover { background: var(--brand-light); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(13, 27, 42, 0.3); }
        
        .btn-circle { 
            width: 40px; height: 40px; border-radius: 50%; border: none; color: white; 
            cursor: pointer; margin-right: 6px; font-size: 1.1rem; transition: 0.2s;
            display: inline-flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-circle:hover { transform: scale(1.15); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        .btn-tool { 
            padding: 10px 20px; border: none; border-radius: 8px; color: white; 
            font-weight: 700; cursor: pointer; font-size: 0.8rem; 
            display: inline-flex; align-items: center; gap: 8px; margin-left: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.2s;
        }
        .btn-tool:hover { filter: brightness(1.1); transform: translateY(-1px); }
        
        .bg-wa { background: var(--whatsapp); }
        .bg-edit { background: var(--brand-gold); }
        .bg-del { background: var(--danger); }
        .bg-dl { background: var(--success); }
        .bg-ul { background: var(--blue); }
        
        /* --- DOCUMENTOS PARA IMPRESI√ìN --- */
        .doc-page { 
            display: none; background: white; width: 21.59cm; min-height: 27.94cm; 
            margin: 0 auto 50px auto; padding: 1.5cm 2cm; box-sizing: border-box; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); border: 1px solid #e0e0e0;
        }
        .doc-header { 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 4px solid var(--brand-dark); padding-bottom: 20px; margin-bottom: 30px; 
        }
        .contract-text { font-size: 9pt; text-align: justify; line-height: 1.6; color: #111; }
        .clause-title { 
            color: var(--brand-dark); font-family: 'Montserrat'; font-weight: 800; 
            text-transform: uppercase; display: block; margin-top: 18px; margin-bottom: 6px; 
            border-bottom: 2px solid var(--brand-gold); font-size: 9.5pt; padding-bottom: 2px;
        }

        @media print {
            body { background: white; padding: 0; margin: 0; }
            .no-print, #login-overlay, .nav-bar, .card { display: none !important; }
            .doc-page { display: block !important; box-shadow: none; margin: 0; width: 100%; page-break-after: always; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <img src="chiwowow 2.png" alt="Logo" class="login-logo">
            <h3 style="font-family:'Montserrat'; color:var(--brand-dark);">Sistema Chi-Wow-Wow</h3>
            <input type="password" id="pass" style="text-align:center; margin-bottom:20px;" placeholder="Contrase√±a de Acceso">
            <button class="btn-main" onclick="entrar()">INGRESAR AL SISTEMA</button>
        </div>
    </div>

    <div class="main-container" id="sistema">
        
        <div class="nav-bar no-print">
            <button class="nav-btn active" id="tab-reg" onclick="mostrarSeccion('nuevo')"><i class="fas fa-edit"></i> Registro</button>
            <button class="nav-btn" id="tab-hist" onclick="mostrarSeccion('historial')"><i class="fas fa-list"></i> Expedientes</button>
            <button class="nav-btn crm-tab" id="tab-crm" onclick="mostrarSeccion('crm')"><i class="fas fa-users"></i> CRM Clientes</button>
        </div>

        <div class="card no-print" id="sec-registro">
            <div class="panel-header">
                <h2 class="panel-title"><i class="fas fa-passport"></i> Gesti√≥n de Reservaciones</h2>
            </div>
            <input type="hidden" id="edit_id">
            
            <div class="form-grid">
                <div><label>Nombre del Titular</label><input type="text" id="in_nombre" placeholder="Nombre completo"></div>
                <div><label>WhatsApp (10 d√≠gitos)</label><input type="text" id="in_tel" placeholder="Ej: 614..."></div>
                <div><label>Red Social del Cliente</label><input type="text" id="in_social" placeholder="Ej: Facebook, TikTok..."></div>
            </div>

            <div class="form-grid">
                <div>
                    <label>Destino / Servicio</label>
                    <select id="in_servicio" onchange="toggleManualInput(this)">
                        <option>Expedici√≥n Creel y Chepe</option>
                        <option>Huasteca Potosina</option>
                        <option>Renta de Van</option>
                        <option>Sierra Tarahumara Especial</option>
                        <option value="OTRO">OTRO (Especificar...)</option>
                    </select>
                    <input type="text" id="in_servicio_manual" placeholder="Escriba el nombre del destino..." style="display:none; margin-top:10px; background:#fff; border-color: var(--blue);">
                </div>
                <div><label>Fechas del Viaje</label><input type="text" id="in_fechas" placeholder="Ej: 15 al 20 de Julio"></div>
                <div><label>Costo Total ($)</label><input type="number" id="in_total" placeholder="0.00"></div>
            </div>

            <div style="margin-bottom:20px;">
                <label>Notas del Expediente (Log√≠stica Interna, Alergias, Puntos de Reuni√≥n)</label>
                <textarea id="in_notas" rows="3" placeholder="Informaci√≥n importante para la operaci√≥n..."></textarea>
            </div>

            <div class="abono-box">
                <h4 class="abono-header"><i class="fas fa-money-bill-wave"></i> REGISTRAR ABONO / PAGO</h4>
                <div class="form-grid">
                    <div><label>Monto a Abonar ($)</label><input type="number" id="in_abono" placeholder="0.00"></div>
                    <div><label>M√©todo de Pago</label>
                        <select id="in_metodo"><option>Transferencia</option><option>Efectivo</option><option>Tarjeta</option><option>Dep√≥sito</option></select>
                    </div>
                    <div><label>Fecha de Pago</label><input type="date" id="in_fecha_pago"></div>
                </div>
            </div>

            <button class="btn-main" onclick="guardar()"><i class="fas fa-save"></i> GUARDAR Y GENERAR DOCUMENTOS</button>
            <button class="btn-main" style="background:#95a5a6; margin-top:15px;" onclick="limpiarForm()"><i class="fas fa-eraser"></i> CANCELAR / NUEVO</button>
        </div>

        <div id="sec-historial" style="display:none;" class="no-print">
            <div class="panel-header">
                <h2 class="panel-title">Base de Datos de Expedientes</h2>
                <div>
                    <button class="btn-tool bg-dl" onclick="descargarRespaldo()"><i class="fas fa-download"></i> Descargar JSON</button>
                    <button class="btn-tool bg-ul" onclick="document.getElementById('file-input').click()"><i class="fas fa-upload"></i> Cargar JSON</button>
                    <input type="file" id="file-input" style="display:none" onchange="cargarJSON(this)">
                </div>
            </div>
            
            <input type="text" id="search-hist" style="width:100%; padding:15px; margin-bottom:25px; border:2px solid var(--brand-gold); border-radius:10px; font-size: 1rem;" placeholder="üîç Buscar por Folio, Cliente o Destino..." onkeyup="filtrar('hist')">
            
            <div class="table-responsive">
                <table id="tabla-historial">
                    <thead><tr><th>Folio</th><th>Cliente / Notas</th><th>Servicio</th><th>Saldo</th><th>Acciones</th></tr></thead>
                    <tbody id="tbody-historial"></tbody>
                </table>
            </div>
        </div>

        <div id="sec-crm" style="display:none;" class="no-print">
            <div class="panel-header">
                <h2 class="panel-title" style="color:var(--crm-bg);">CRM de Clientes</h2>
            </div>
            <input type="text" id="search-crm" style="width:100%; padding:15px; margin-bottom:25px; border:2px solid var(--crm-bg); border-radius:10px; font-size: 1rem;" placeholder="üîç Buscar Cliente en la Base de Datos..." onkeyup="filtrar('crm')">
            <div class="table-responsive">
                <table id="tabla-crm">
                    <thead><tr><th>Cliente</th><th>Datos de Contacto</th><th>Historial de Viajes</th><th>Acci√≥n R√°pida</th></tr></thead>
                    <tbody id="tbody-crm"></tbody>
                </table>
            </div>
        </div>

        <div id="doc-recibo" class="doc-page">
            <div class="doc-header">
                <img src="chiwowow 2.png" style="height:80px;">
                <div style="text-align:right;">
                    <h1 style="margin:0; font-family:'Montserrat'; font-size:20pt; color:var(--brand-dark);">RECIBO DE PAGO</h1>
                    <p id="out_folio" style="color:var(--brand-gold); font-weight:800; font-size:1.5rem; margin:0;"></p>
                </div>
            </div>
            
            <div style="font-size:9pt; margin-bottom:25px; border-left:5px solid var(--brand-dark); padding-left:15px; color:#444; line-height: 1.6;">
                <strong>EMISOR:</strong> CHIWOW-WOW A & T, S.A. DE C.V.<br>
                <strong>RFC:</strong> CAT2205094P0<br>
                <strong>DOMICILIO:</strong> AV. HEROICO COLEGIO MILITAR 7716, COL. NOMBRE DE DIOS, C.P. 31150, CHIHUAHUA, CHIH.<br>
                <strong>TEL√âFONO:</strong> 614 286 0572
            </div>

            <div style="background:#F8F9F9; padding:20px; border-radius:12px; font-size:10pt; margin-bottom:25px; border: 1px solid #eee;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div><strong>CLIENTE:</strong> <span id="out_cliente"></span></div>
                    <div><strong>RED SOCIAL:</strong> <span id="out_social_doc"></span></div>
                    <div><strong>SERVICIO:</strong> <span id="out_servicio"></span></div>
                    <div><strong>FECHAS:</strong> <span id="out_fechas"></span></div>
                </div>
            </div>

            <table style="width:100%; border-collapse:collapse; font-size:10pt;">
                <thead style="background:var(--brand-dark); color:white;">
                    <tr><th style="padding:12px;">FECHA</th><th style="padding:12px;">M√âTODO DE PAGO</th><th style="padding:12px; text-align:right;">MONTO</th></tr>
                </thead>
                <tbody id="out_abonos"></tbody>
            </table>

            <div style="text-align:right; margin-top:30px; border-top:3px solid var(--brand-gold); padding-top:15px;">
                <p style="margin:5px 0; font-size: 11pt;">COSTO TOTAL: <span id="out_total"></span></p>
                <p style="margin:5px 0; font-size: 11pt;">TOTAL ABONADO: <span id="out_pagado"></span></p>
                <h2 style="color:var(--danger); margin:10px 0; font-size:1.8rem;">SALDO PENDIENTE: <span id="out_saldo"></span></h2>
            </div>

            <div style="margin-top:50px; border-top:1px solid #eee; padding-top:15px; text-align:center; font-size:9pt; color:#666;">
                <i class="fab fa-facebook"></i> Chi-Wow-Wow Adventure & Travel &nbsp;&nbsp;|&nbsp;&nbsp; 
                <i class="fab fa-tiktok"></i> Chi-Wow-Wow A&T &nbsp;&nbsp;|&nbsp;&nbsp; 
                <i class="fab fa-whatsapp"></i> 614 286 0572
            </div>
        </div>

        <div id="doc-contrato" class="doc-page">
            <div class="doc-header" style="border-bottom:3px solid var(--brand-gold);">
                <img src="chiwowow 2.png" style="height:60px;">
                <h2 style="margin:0; font-family:'Montserrat'; font-size:16pt;">CONTRATO DE ADHESI√ìN Y SERVICIOS</h2>
            </div>
            <div class="contract-text">
                <p>Contrato de prestaci√≥n de servicios tur√≠sticos que celebran por una parte <strong>CHIWOW-WOW A & T, S.A. DE C.V.</strong> (LA EMPRESA) y por la otra el C. <strong id="out_cliente_con"></strong> (EL CLIENTE).</p>

                <span class="clause-title">1. RESERVACIONES, ANTICIPOS Y LIQUIDACI√ìN</span>
                <p>EL CLIENTE acepta que todo anticipo o pago realizado es <strong>ESTRICTAMENTE NO REEMBOLSABLE</strong>. El saldo total del viaje deber√° estar liquidado al 100% al menos 72 horas antes de la salida programada.</p>

                <span class="clause-title">2. RESPONSABILIDAD DE TERCEROS (DESLINDE)</span>
                <p>LA EMPRESA act√∫a como intermediario log√≠stico. No se hace responsable por accidentes, lesiones, enfermedades, robos o deficiencias en el servicio ocurridos dentro de instalaciones de terceros tales como: hoteles, restaurantes, parques de aventura, telef√©ricos, aerol√≠neas o transporte ajeno.</p>

                <span class="clause-title">3. FUERZA MAYOR Y CONTINGENCIAS</span>
                <p>No somos responsables por retrasos, cancelaciones o cambios de itinerario derivados de: clima adverso, bloqueos carreteros, fallas en el Tren Chepe, huelgas o pandemias. En estos casos, se emitir√° un certificado de viaje para reprogramaci√≥n seg√∫n disponibilidad; <strong>no se realizar√°n reembolsos en efectivo</strong>.</p>

                <span class="clause-title">4. EQUIPAJE Y OBJETOS PERSONALES</span>
                <p>EL CLIENTE es el √∫nico responsable de su equipaje y art√≠culos de valor. LA EMPRESA no responde por p√©rdidas, robos o da√±os de maletas o dispositivos electr√≥nicos durante el trayecto o estancias.</p>

                <span class="clause-title">5. CONDUCTA Y DERECHO DE ADMISI√ìN</span>
                <p>Queda prohibido el consumo de sustancias ilegales o alcohol excesivo en la unidad. EL CLIENTE que ponga en riesgo la seguridad o armon√≠a del grupo ser√° retirado del tour sin derecho a reembolso ni transporte de regreso.</p>

                <span class="clause-title">6. AVISO DE PRIVACIDAD Y USO DE IMAGEN</span>
                <p>EL CLIENTE autoriza el uso de fotos o videos capturados durante el viaje para fines promocionales de LA EMPRESA en redes sociales y publicidad oficial.</p>
            </div>

            <div style="display:flex; justify-content:space-between; margin-top:80px; text-align:center;">
                <div style="width:40%; border-top:2px solid var(--brand-dark); padding-top:15px;">
                    <strong>CHIWOW-WOW A & T, S.A. DE C.V.</strong><br><small>PRESTADOR DEL SERVICIO</small>
                </div>
                <div style="width:40%; border-top:2px solid var(--brand-dark); padding-top:15px;">
                    <span id="out_firma"></span><br><small>FIRMA DE CONFORMIDAD DEL CLIENTE</small>
                </div>
            </div>
            
            <div class="no-print" style="text-align:center; margin-top:50px;">
                <button class="btn-main" style="width:350px; background:var(--brand-dark);" onclick="window.print()">üñ®Ô∏è IMPRIMIR EXPEDIENTE COMPLETO</button>
            </div>
        </div>

    </div>

    <script>
        // --- GESTI√ìN DE DATOS Y MIGRACI√ìN ---
        let db = [];
        // Lista de claves antiguas para buscar datos perdidos y unificarlos
        const clavesHistoricas = ['chiwowow_final_v7', 'chiwowow_final_v6', 'chiwowow_final_db', 'chiwowow_ventas', 'chiwowow_master_db', 'cww_data'];

        function inicializarBaseDatos() {
            let datosRecuperados = [];
            let idsProcesados = new Set();
            let datosEncontrados = false;

            // Barrido de todas las posibles ubicaciones de datos
            clavesHistoricas.forEach(clave => {
                let data = localStorage.getItem(clave);
                if(data) {
                    try {
                        let parsed = JSON.parse(data);
                        if(Array.isArray(parsed)) {
                            parsed.forEach(registro => {
                                if(!idsProcesados.has(registro.id)) {
                                    datosRecuperados.push(registro);
                                    idsProcesados.add(registro.id);
                                    datosEncontrados = true;
                                }
                            });
                        }
                    } catch(e) { console.error("Error leyendo clave:", clave); }
                }
            });

            if(datosRecuperados.length > 0) {
                db = datosRecuperados;
                guardarCambios(); // Unificar todo en la versi√≥n actual
            }
        }

        function guardarCambios() {
            // Guardamos en la clave definitiva
            localStorage.setItem('chiwowow_master_final', JSON.stringify(db));
        }

        // Cargar al inicio
        const datosActuales = localStorage.getItem('chiwowow_master_final');
        if(datosActuales) {
            db = JSON.parse(datosActuales);
        } else {
            inicializarBaseDatos();
        }

        document.getElementById('in_fecha_pago').valueAsDate = new Date();

        // --- L√ìGICA DE INTERFAZ ---
        function entrar() {
            if(document.getElementById('pass').value.toLowerCase() === "grchiwowow") {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('sistema').style.display = 'block';
                renderizarTablas();
            }
        }

        function toggleManualInput(select) {
            const inputManual = document.getElementById('in_servicio_manual');
            if(select.value === 'OTRO') {
                inputManual.style.display = 'block';
                inputManual.focus();
            } else {
                inputManual.style.display = 'none';
                inputManual.value = '';
            }
        }

        function guardar() {
            let id = document.getElementById('edit_id').value || Date.now().toString();
            let monto = parseFloat(document.getElementById('in_abono').value) || 0;
            
            // Determinar servicio final
            let sel = document.getElementById('in_servicio');
            let servicioFinal = sel.value === 'OTRO' ? document.getElementById('in_servicio_manual').value : sel.value;

            if(!servicioFinal) { alert("Por favor define un destino o servicio."); return; }

            let nuevoRegistro = {
                id: id,
                folio: "", // Se mantiene si existe, se crea si es nuevo
                nombre: document.getElementById('in_nombre').value,
                tel: document.getElementById('in_tel').value,
                social: document.getElementById('in_social').value,
                servicio: servicioFinal,
                fechas: document.getElementById('in_fechas').value,
                total: parseFloat(document.getElementById('in_total').value) || 0,
                notas: document.getElementById('in_notas').value,
                abonos: [] // Se llena abajo
            };

            let indice = db.findIndex(x => x.id == id);

            if(indice > -1) {
                // EDICI√ìN: Conservar folio y abonos previos
                nuevoRegistro.folio = db[indice].folio;
                nuevoRegistro.abonos = db[indice].abonos;
                
                // Agregar abono nuevo si existe
                if(monto > 0) {
                    nuevoRegistro.abonos.push({
                        monto: monto, 
                        fecha: document.getElementById('in_fecha_pago').value, 
                        metodo: document.getElementById('in_metodo').value
                    });
                }
                db[indice] = nuevoRegistro;
            } else {
                // NUEVO REGISTRO
                nuevoRegistro.folio = "CWW-" + Math.floor(10000 + Math.random() * 90000);
                if(monto > 0) {
                    nuevoRegistro.abonos.push({
                        monto: monto, 
                        fecha: document.getElementById('in_fecha_pago').value, 
                        metodo: document.getElementById('in_metodo').value
                    });
                }
                db.push(nuevoRegistro);
            }

            guardarCambios();
            prepararDocumentos(id);
        }

        function prepararDocumentos(id) {
            let r = db.find(x => x.id == id);
            let fmt = new Intl.NumberFormat('es-MX', {style:'currency', currency:'MXN'});
            let pagado = r.abonos.reduce((s,a)=>s+a.monto,0);

            // Llenar datos visuales
            document.getElementById('out_folio').innerText = r.folio;
            document.getElementById('out_cliente').innerText = r.nombre;
            document.getElementById('out_social_doc').innerText = r.social || 'No registrada';
            document.getElementById('out_servicio').innerText = r.servicio;
            document.getElementById('out_fechas').innerText = r.fechas;
            
            document.getElementById('out_total').innerText = fmt.format(r.total);
            document.getElementById('out_pagado').innerText = fmt.format(pagado);
            document.getElementById('out_saldo').innerText = fmt.format(r.total - pagado);
            
            // Llenar contrato
            document.getElementById('out_cliente_con').innerText = r.nombre;
            document.getElementById('out_firma').innerText = r.nombre;

            // Tabla de abonos en recibo
            let htmlAbonos = "";
            r.abonos.forEach(a => {
                htmlAbonos += `<tr><td>${a.fecha}</td><td>${a.metodo}</td><td style="text-align:right;">${fmt.format(a.monto)}</td></tr>`;
            });
            document.getElementById('out_abonos').innerHTML = htmlAbonos;

            mostrarSeccion('impresion');
        }

        function renderizarTablas() {
            let tbodyHist = document.getElementById('tbody-historial');
            let tbodyCRM = document.getElementById('tbody-crm');
            let fmt = new Intl.NumberFormat('es-MX', {style:'currency', currency:'MXN'});
            let clientesMap = {};

            tbodyHist.innerHTML = "";
            tbodyCRM.innerHTML = "";

            // Ordenar por m√°s reciente
            db.sort((a,b) => b.id - a.id).forEach(r => {
                let pagado = r.abonos.reduce((s,a)=>s+a.monto,0);
                let saldo = r.total - pagado;
                
                // 1. Tabla Historial
                tbodyHist.innerHTML += `
                    <tr>
                        <td><strong>${r.folio}</strong></td>
                        <td>
                            <b>${r.nombre}</b>
                            <span class="note-preview"><i class="fas fa-sticky-note"></i> ${r.notas || 'Sin notas'}</span>
                        </td>
                        <td>${r.servicio}</td>
                        <td style="color:${saldo > 0 ? 'var(--danger)' : 'var(--success)'}; font-weight:bold;">${fmt.format(saldo)}</td>
                        <td>
                            <button class="btn-circle" style="background:var(--whatsapp)" onclick="enviarWA('${r.id}')" title="WhatsApp"><i class="fab fa-whatsapp"></i></button>
                            <button class="btn-circle" style="background:var(--brand-gold)" onclick="editar('${r.id}')" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="btn-circle" style="background:var(--danger)" onclick="borrar('${r.id}')" title="Eliminar"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;

                // 2. Agrupaci√≥n para CRM
                if(!clientesMap[r.nombre]) {
                    clientesMap[r.nombre] = { 
                        tel: r.tel, 
                        social: r.social, 
                        viajes: [] 
                    };
                }
                clientesMap[r.nombre].viajes.push(r.servicio);
            });

            // 3. Renderizar CRM
            for(let nombre in clientesMap) {
                let c = clientesMap[nombre];
                tbodyCRM.innerHTML += `
                    <tr>
                        <td><strong>${nombre}</strong></td>
                        <td>
                            <i class="fab fa-whatsapp"></i> ${c.tel}<br>
                            <span class="social-badge"><i class="fab fa-facebook"></i> ${c.social || 'N/R'}</span>
                        </td>
                        <td>${c.viajes.join(', ')}</td>
                        <td>
                            <a href="https://wa.me/52${c.tel.replace(/\D/g,'')}" target="_blank" class="btn-tool bg-ul" style="text-decoration:none; padding:5px 10px;">Contactar</a>
                        </td>
                    </tr>
                `;
            }
        }

        function editar(id) {
            let r = db.find(x => x.id == id);
            document.getElementById('edit_id').value = r.id;
            document.getElementById('in_nombre').value = r.nombre;
            document.getElementById('in_tel').value = r.tel;
            document.getElementById('in_social').value = r.social || '';
            document.getElementById('in_fechas').value = r.fechas;
            document.getElementById('in_total').value = r.total;
            document.getElementById('in_notas').value = r.notas || '';
            
            // Manejo del selector de servicio
            let sel = document.getElementById('in_servicio');
            let manual = document.getElementById('in_servicio_manual');
            let opciones = Array.from(sel.options).map(o => o.value);
            
            if(opciones.includes(r.servicio)) {
                sel.value = r.servicio;
                manual.style.display = 'none';
            } else {
                sel.value = 'OTRO';
                manual.style.display = 'block';
                manual.value = r.servicio;
            }

            mostrarSeccion('nuevo');
        }

        function borrar(id) {
            if(confirm("ATENCI√ìN: ¬øSeguro que deseas eliminar este expediente permanentemente?")) {
                db = db.filter(x => x.id != id);
                guardarCambios();
                renderizarTablas();
            }
        }

        function enviarWA(id) {
            let r = db.find(x => x.id == id);
            let saldo = r.total - r.abonos.reduce((s,a)=>s+a.monto,0);
            let msg = `Hola *${r.nombre}*, te saludamos de Chi-Wow-Wow A&T. Confirmamos tu expediente *${r.folio}* para *${r.servicio}*. Saldo pendiente: *$${saldo}*.`;
            window.open(`https://wa.me/52${r.tel.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`);
        }

        function mostrarSeccion(sec) {
            // Ocultar todo
            ['sec-registro', 'sec-historial', 'sec-crm', 'doc-recibo', 'doc-contrato'].forEach(id => document.getElementById(id).style.display = 'none');
            
            // Quitar clase activa a botones
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            if(sec === 'nuevo') {
                document.getElementById('sec-registro').style.display = 'block';
                document.getElementById('tab-reg').classList.add('active');
            } else if(sec === 'historial') {
                document.getElementById('sec-historial').style.display = 'block';
                document.getElementById('tab-hist').classList.add('active');
                renderizarTablas();
            } else if(sec === 'crm') {
                document.getElementById('sec-crm').style.display = 'block';
                document.getElementById('tab-crm').classList.add('active');
                renderizarTablas();
            } else if(sec === 'impresion') {
                document.getElementById('doc-recibo').style.display = 'block';
                document.getElementById('doc-contrato').style.display = 'block';
            }
        }

        function limpiarForm() {
            document.getElementById('edit_id').value = "";
            document.getElementById('in_nombre').value = "";
            document.getElementById('in_abono').value = "";
            document.getElementById('in_notas').value = "";
            document.getElementById('in_servicio').value = "Expedici√≥n Creel y Chepe";
            document.getElementById('in_servicio_manual').style.display = "none";
            mostrarSeccion('nuevo');
        }

        function descargarRespaldo() {
            let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            let link = document.createElement('a');
            link.setAttribute("href", dataStr);
            link.setAttribute("download", "RESPALDO_CHIWOWOW_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(link);
            link.click();
            link.remove();
        }

        function cargarJSON(input) {
            let file = input.files[0];
            if(!file) return;
            let reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let loaded = JSON.parse(e.target.result);
                    // Fusi√≥n inteligente: Solo agrega si el ID no existe
                    let agregados = 0;
                    loaded.forEach(r => {
                        if(!db.find(exist => exist.id == r.id)) {
                            db.push(r);
                            agregados++;
                        }
                    });
                    guardarCambios();
                    renderizarTablas();
                    alert(`Respaldo cargado con √©xito. Se agregaron ${agregados} expedientes recuperados.`);
                } catch(err) {
                    alert("Error al leer el archivo. Aseg√∫rate que sea un JSON v√°lido.");
                }
            };
            reader.readAsText(file);
        }

        function filtrar(tipo) {
            let query = document.getElementById(tipo === 'hist' ? 'search-hist' : 'search-crm').value.toLowerCase();
            let rows = document.querySelectorAll(`#${tipo === 'hist' ? 'tabla-historial' : 'tabla-crm'} tbody tr`);
            rows.forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(query) ? '' : 'none';
            });
        }
    </script>
</body>
</html>
